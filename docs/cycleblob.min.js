var cb=function(){function t(t,e){return Math.floor(Math.random()*(e-t+1))+t}function r(t){return Math.random()<t/100}function n(t){var e=$e.getError();e!=$e.NO_ERROR&&(n.codes||(n.codes={},n.codes[$e.INVALID_ENUM]="INVALID_ENUM",n.codes[$e.INVALID_VALUE]="INVALID_VALUE",n.codes[$e.INVALID_OPERATION]="INVALID_OPERATION",n.codes[$e.OUT_OF_MEMORY]="OUT_OF_MEMORY"),alert((t?t+" ":"")+"WebGL error: "+e+" "+n.codes[e]))}function o(t){return t*Math.PI/180}function a(t,e,i){function r(t,e,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?t+6*(e-t)*i:.5>i?e:2/3>i?t+(e-t)*(2/3-i)*6:t}var n,o,a;if(0==e)n=o=a=i;else{
var s=.5>i?i*(1+e):i+e-i*e,l=2*i-s;n=r(l,s,t+1/3),o=r(l,s,t),a=r(l,s,t-1/3)}return[n,o,a]}function s(){this.stack=[];for(var t=0;20>t;++t)this.stack.push(ye.create());this.stackTop=0,this.current=ye.create(),this.loadIdentity()}function l(t,e){var i=e;if(!i)return null;var r,n=i[0],o=n.text;if("x-shader/x-fragment"==n.type)r=t.createShader(t.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=n.type)return null;r=t.createShader(t.VERTEX_SHADER)}return t.shaderSource(r,o),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert(t.getShaderInfoLog(r)+"\n"+n.id),null)}function u(){this.prog=null;
}function h(t){if(1!=arguments.length)throw new Error("GLBuffer() needs 1 arguments");this.buf=$e.createBuffer(),this.target=t}function c(){return c.t||(c.t={},c.t[$e.FLOAT]={byteSize:4,arrCtor:Float32Array},c.t[$e.UNSIGNED_INT]={byteSize:4,arrCtor:Uint32Array},c.t[$e.INT]={byteSize:4,arrCtor:Int32Array},c.t[$e.UNSIGNED_SHORT]={byteSize:2,arrCtor:Uint16Array},c.t[$e.SHORT]={byteSize:2,arrCtor:Int16Array},c.t[$e.UNSIGNED_BYTE]={byteSize:1,arrCtor:Uint8Array},c.t[$e.BYTE]={byteSize:1,arrCtor:Int8Array}),c.t}function f(){this.queue=[],this.pntRecord=[],this.standing=!0}function g(t,e,i){this.alive=!0,
this.model=e,this.id=t,this.ready=!1,this.modelColor=Me[t].model,this.trailColor=Me[t].trail,this.textColor=Me[t].text,this.name=Me[t].name,this.point=i,this.normal=we.create([0,0,1]),this.rightHand=we.create([1,0,0]),this.upDir=we.create([0,1,0]),this.forward=this.upDir,this.last={point:-1,normal:null,upDir:null,forward:null},this.last.point=m(this.point,we.nnegate(this.forward)),this.eDir=Se.Up,this.selDir=Se.Up,this.wall=new f,this.ai=null,this.sfx={explode:null,wall_decent:null},this.lastMadeMoves=0,this.dNow2Last=0,this.dNow2Point=0,this.curStepFrac=1,this.lastMvDist=1,this.turnCallback=null,
this.stepCount=0,this.selDir.move.call(this)}function m(t,e){var r=ni.model.vtx[t],n=ni.model.nei[t].d,o=-100,a=-100;for(i in n){var s=ni.model.vtx[i],l=we.normalize(we.nsubtract(s,r)),u=we.dot(e,l);u>o&&(o=u,a=i)}return parseInt(a)}function v(t,e,i){for(var r=ni.model.nei[t],n=e[r.nc],o=i,a=0;n>a;++a)o=r.t[o];return o}function w(t,e){for(var i=ni.model.nei[t],r={},n=e,o=De.rightHand[i.nc],a=0;o>a;++a)n=i.t[n];r.toRight=n,o=De.forward[i.nc]-De.rightHand[i.nc];for(var a=0;o>a;++a)n=i.t[n];r.toFwd=n,o=De.leftHand[i.nc]-De.forward[i.nc];for(var a=0;o>a;++a)n=i.t[n];return r.toLeft=n,r}function x(t){
Ae.mouseDown=!0,Ae.lastMouseX=t.clientX,Ae.lastMouseY=t.clientY}function y(t){Ae.mouseDown=!1}function b(t){if(Ae.mouseDown){var e=t.clientX,i=t.clientY;if(Ke.debug){var r=e-Ae.lastMouseX,n=i-Ae.lastMouseY,a=ye.nidentity();ye.rotateY(a,o(r/2)),ye.rotateX(a,o(n/2)),ye.multiply(a,Ae.rotationMatrix,Ae.rotationMatrix),Ae.lastMouseX=e,Ae.lastMouseY=i}}}function _(t){var e=!0;return void 0!==Te[t.keyCode]?(Ae.currentlyPressedDirs.push({dir:Te[t.keyCode],skippedCount:0}),e=!1):t.keyCode===Ee._DOM_VK_OPEN_SQUARE?(Ae.currentlyPressedDirs.push({reldir:Se.Left,skippedCount:0}),e=!1):t.keyCode===Ee._DOM_VK_CLOSE_SQUARE&&(Ae.currentlyPressedDirs.push({
reldir:Se.Right,skippedCount:0}),e=!1),t.keyCode===Ee.DOM_VK_P||t.keyCode===Ee.DOM_VK_PAUSE?(Ge.setPaused(!Ge.isPaused()),e=!1):t.keyCode===Ee.DOM_VK_M?(Ge.enableSound(!Ge.soundEnabled),e=!1):t.keyCode===Ee.DOM_VK_ESCAPE?(Ge.setPaused(!0),di.verbosePauseScreen(),e=!1):!Ke.debug&&Ge.isPaused()&&(Ge.setPaused(!1),e=!1),t.keyCode===Ee.DOM_VK_SPACE&&(e=!1),Ke.debug&&(t.keyCode===Ee.DOM_VK_E?G(oi,1):t.keyCode===Ee.DOM_VK_U?(++Ge.userLivesCount,ni.staticDraw.lives.startOneUp()):t.keyCode===Ee.DOM_VK_B&&X()),e}function S(t){}function M(t){for(var e in Ae.currentlyPressedDirs){var i=Ae.currentlyPressedDirs[e];
void 0!==i&&(i.dir?moveDir=si.translateDir(i.dir,t):moveDir=si.translateRelativeDir(Se.getRelativeDir(t.eDir,i.reldir,t)),Qe("SAMP-DIR "+moveDir.name),null!==moveDir&&moveDir!==t.eDir.opposite?(t.selDir=moveDir,Ge.isPaused()&&Ke.debug&&(Qe("DO"),oe(oi),oi.curStepFrac=1),Ae.currentlyPressedDirs[e]=void 0):(++i.skippedCount,i.skippedCount>4&&(Ae.currentlyPressedDirs[e]=void 0)))}}function D(t){return t.preventDefault(),Re=t.touches[0].clientX,Pe=t.touches[0].clientY,!1}function A(t){if(t.preventDefault(),!Re||!Pe)return!1;var e=t.touches[0].clientX,i=t.touches[0].clientY,r=Re-e,n=Pe-i,o=Math.abs(r),a=Math.abs(n);
Qe("TOUCH "+r+" "+n);var s=null;return o>a?o>10&&(s=r>0?Se.Left:Se.Right):a>10&&(s=n>0?Se.Up:Se.Down),null!==s&&(Ae.currentlyPressedDirs.push({dir:s,skippedCount:0}),Re=null,Re=null,Ge.setPaused(!1)),!1}function E(t){return t.preventDefault(),Re=null,Re=null,!1}function T(t,e){t.onmousedown=x,e.onmousedown=x,document.onmouseup=y,document.onmousemove=b,document.onkeydown=_,document.onkeyup=S,document.body.addEventListener("touchstart",D,!1),document.body.addEventListener("touchmove",A,!1),document.body.addEventListener("touchend",E,!1),document.body.addEventListener("touchcancel",E,!1),Ae.handlersSet=Ae.HANDLERS_3D;
}function R(t,e){var i=["triangles","lines"];for(var r in i){var n=i[r];t[n]&&(e[n]=h.Data($e.ELEMENT_ARRAY_BUFFER,new Uint16Array(t[n]),$e.STATIC_DRAW,1))}if(t.quads){var o=new Uint16Array(t.quads.length/4*6);ti=0;for(var r=0;r<t.quads.length;r+=4)o[ti++]=t.quads[r],o[ti++]=t.quads[r+1],o[ti++]=t.quads[r+2],o[ti++]=t.quads[r],o[ti++]=t.quads[r+2],o[ti++]=t.quads[r+3];e.triangles=h.Data($e.ELEMENT_ARRAY_BUFFER,o,$e.STATIC_DRAW,1)}}function P(t,e){if(e.vertexBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(t.vertexPositions),$e.STATIC_DRAW,3),t.vertexNormals&&(e.vNormalBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(t.vertexNormals),$e.STATIC_DRAW,3)),
t.vertexTextureCoords&&(e.vTexCoord=h.Data($e.ARRAY_BUFFER,new Float32Array(t.vertexTextureCoords),$e.STATIC_DRAW,2)),t.groups){e.groups=[];for(var i in t.groups){var r=t.groups[i],n={};R(r,n),e.groups.push(n)}}else R(t,e)}function I(t,e){e.groups=[];for(var i in t.groups){for(var r=t.groups[i],n={},o=[],a=[],s=0;s<r.triangles.length;){for(var l=[],u=0;3>u;++u){var d=r.triangles[s],c=[t.vertexPositions[3*d],t.vertexPositions[3*d+1],t.vertexPositions[3*d+2]];o.push.apply(o,c),l[u]=c,++s}for(var p=we.ncross(we.nsubtract(l[0],l[1]),we.nsubtract(l[0],l[2])),u=0;3>u;++u)a.push(p[0],p[1],p[2])}n.vertexBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(o),$e.STATIC_DRAW,3),
n.vNormalBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(a),$e.STATIC_DRAW,3),n.trianglesInline=!0,n.diffuseColor=r.diffuseColor,e.groups.push(n)}}function k(t,e,i){t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2]}function L(t,e,i,r){for(var n=new Float32Array(3*t.totalNeiCount),o=new Float32Array(3*t.totalNeiCount),a=[],s=[],l=0,u=0,d=0;d<t.nei.length;++d)t.nei[d].tc={};var d=0,c=function(){for(var e=0;100>e;++e){var i=t.vtx[d],r=t.normals[d],h=Object.keys(t.nei[d].t),f=t.nei[d].nc;for(var g in t.nei[d].d)t.nei[d].tc[g]=[];for(var m=s[d]=l,v=t.nei[d].t[h[0]],w=0;f>w;++w){var x=t.nei[d].t[v],y=we.nsubtract(t.vtx[v],i),b=we.nsubtract(t.vtx[x],i),_=y;
we.normalize(we.add(_,b)),we.scale(_,1.41421*t.scale.GRID_LINE_WIDTH),we.add(_,i),t.nei[d].tc[v].unshift(l),t.nei[d].tc[x].push(l),k(n,u,_),k(o,u,r),++l,u+=3,v=x}for(var S=1;S<t.nei[d].nc-1;++S)a.push(m,m+S,m+S+1);if(++d,d>=t.vtx.length)break}var M=d<t.vtx.length?c:p;return M},p=function(){l>65536&&alert("model too big "+vtxBuf.length+" vertices");for(var e=new Array(t.vtx.length),i=0;i<e.length;++i)e[i]={};for(var i=0;i<t.vtx.length;++i)for(var r in t.nei[i].d){r=parseInt(r);var u=r>i?[i,r]:[r,i];if(!e[u[0]][u[1]]){e[u[0]][u[1]]=!0;var d=t.nei[i].tc[r],c=t.nei[r].tc[i];a.push(d[0],c[1],c[0]),a.push(d[0],c[0],d[1]);
}}delete e,delete s,"undefined"!=typeof $e?(t.vertexBuffer=h.Data($e.ARRAY_BUFFER,n,$e.STATIC_DRAW,3),t.vNormalBuffer=h.Data($e.ARRAY_BUFFER,o,$e.STATIC_DRAW,3),t.triangles=h.Data($e.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),$e.STATIC_DRAW,1),delete n,delete o,delete a):(t.vertexBuffer=n,t.vNormalBuffer=o,t.triangles=new Uint16Array(a));for(var i=0;i<t.nei.length;++i)delete t.nei[i].tc;return null},f=c,g=function(){f=f(),null===f?(r&&r(1),i()):r&&(e=r(d/(t.vtx.length+200)))},m=function(){if(g(),null!==f&&e)setTimeout(m,100);else for(;null!==f&&!e;)g()};m()}function C(t,e,i){return we.distance(t.vtx[e],t.vtx[i]);
}function O(t,e){e.vtx=[],e.bbox={min:we.create([99,99,99]),max:we.create([-99,-99,-99])};for(var i=0;i<t.vertexPositions.length;i+=3)p=we.create([t.vertexPositions[i],t.vertexPositions[i+1],t.vertexPositions[i+2]]),e.vtx.push(p),we.minwith(e.bbox.min,p),we.maxwith(e.bbox.max,p);if(e.bbox.size=we.distance(e.bbox.min,e.bbox.max),Qe(e.vtx.length+" vertices in world bbox="+e.bbox.size),e.normals=[],t.vertexNormals)for(var i=0;i<t.vertexNormals.length;i+=3)e.normals.push(we.create([t.vertexNormals[i],t.vertexNormals[i+1],t.vertexNormals[i+2]]));e.nei=[];for(var r=new Array(e.vtx.length),i=0;i<r.length;++i)r[i]={
d:{},t:{},nc:0};if(!t.quads)throw new Error("not supported");for(var n,o=0,a=0,i=0;i<t.quads.length;i+=4){var s=t.quads[i],l=t.quads[i+1],u=t.quads[i+2];n=t.quads[i+3],ds=C(e,s,l),r[s].d[l]=ds,r[l].d[s]=ds,o+=ds,ds=C(e,l,u),r[l].d[u]=ds,r[u].d[l]=ds,o+=ds,ds=C(e,u,n),r[u].d[n]=ds,r[n].d[u]=ds,o+=ds,ds=C(e,n,s),r[n].d[s]=ds,r[s].d[n]=ds,o+=ds,a+=4,r[s].t[l]=n,r[l].t[u]=s,r[u].t[n]=l,r[n].t[s]=u}for(var h=0,i=0;i<r.length;++i){var d=Object.keys(r[i].t);r[i].nc=d.length,h+=d.length}e.totalNeiCount=h,e.distAvg=o/a,e.scale=F(e.distAvg),Qe(e.distAvg),e.nei=r}function F(t){var e={};return e.GRID_LINE_WIDTH=.19*t,
e.WALL_WIDTH=.28*t,e.WALL_HEIGHT=1.92*t,e.BIKE_SCALE=.96*t,e.BASE_SPEED=.01522*t,e.GLOBAL_SCALE=t/.052,e.BONUS_LIFE=.475*t,e}function B(t){for(var e=[],i=[],r=[],n=0;Ie>n;++n){var o=2*Math.PI/Ie*n,a=Math.cos(o),s=Math.sin(o);e.push(a,s,0,a*(1+ke),s*(1+ke),0),i.push(0,0,1,0,0,1),r.push(2*n,2*n+1)}r.push(0,1),t.ring={},t.ring.vertexBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(e),$e.STATIC_DRAW,3),t.ring.vNormalBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(i),$e.STATIC_DRAW,3),t.ring.triangleStrip=h.Data($e.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),$e.STATIC_DRAW,1),e=[],i=[];for(var l=[],u=2*Math.PI/Le,n=0;Le>n;++n){
var o=u*n;o+=(Math.random()-.5)*u;var d=.4*(Math.random()-.5)+1,a=Math.cos(o),s=Math.sin(o),c=s*Ce,p=-a*Ce;e.push(a*d,s*d,0,c,p,0,-c,-p,0),i.push(0,0,1,0,0,1,0,0,1),l.push(3*n,3*n+1,3*n+2)}t.spikes={},t.spikes.vertexBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(e),$e.STATIC_DRAW,3),t.spikes.vNormalBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(i),$e.STATIC_DRAW,3),t.spikes.triangleStrip=h.Data($e.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),$e.STATIC_DRAW,1)}function N(t,e){this.player=t;var i=Oe[e];this.stepsAhead=i.stepsAhead,this.look=new H,this.occFwd=!0,this.occLeft=!0,this.occRight=!0}function U(t){
var e=ni.map.getPiece(t);return void 0!==e&&e>=0}function H(t,e){this.init(t,e)}function V(t,e,i){return 0===e?i:t.goForward()?V(t,e-1,i+1):i}function W(t,e){return t>=100&&200>t&&t-100==e}function K(t){this.player=t,this.ringsScale=[-1,-.5,.01],this.elapsed=0,this.showSpikes=!0,this.spikesScale=.1}function G(t,e){100>e&&e==oi.id&&(t=oi),t.sfx.explode=new K(t)}function Y(t){this.player=t,this.brightness=0,this.height=1,this.elapsed=0}function z(t){t.sfx.wall_decent=new Y(t)}function q(t){window.setTimeout(function(){z(t)},K.TOTAL_TIME+Y.START_DELAY)}function X(){if(!(Object.keys(ni.bonuses).length>=5||ni.bonuses.length>99)){
var t=new Q(ni.bonuses.length);null!==t.point&&ni.bonuses.push(t)}}function Q(t){var e=Ot();if(this.point=e[0],null!==this.point){this.index=t,this.occupy=e;for(var i in this.occupy)ni.map.set(this.occupy[i],1e3+t,0);this.normal=ni.model.normals[this.point],this.forward=we.normalize(we.nsubtract(ni.model.vtx[this.point],ni.model.vtx[e[1]])),this.rightHand=we.ncross(this.forward,this.normal),this.forward=we.ncross(this.normal,this.rightHand),this.anglex=0,this.angley=0,this.elapsed=0,this.inflate=0,this.active=!0,this.removeElapsed=-1,this.alpha=null,di.addMessage("Life bonus appeared")}}function j(t){
this.eye=we.create([0,0,1]),this.upDir=we.create([0,1,0]),this.eyeDist=t,this.toPoint=we.create([0,0,0]),this.twoSided=!1,this.addNearClip=0,this.lightPoint=[-10,4,20]}function Z(){this.eye=we.create([0,0,0]),this.upDir=we.create([0,1,0]),this.toPoint=we.create([0,0,1]),this.centerDist=1.5,this.addNearClip=Math.max(0,this.centerDist-.8),this.twoSided=!0,this.bikeFlip=!0,this.lightPoint=[0,-4,20]}function J(){this.eye=we.create([0,0,0]),this.upDir=we.create([0,1,0]),this.toPoint=we.create([0,0,0]),this.t=we.create(),this.twoSided=!1,this.addNearClip=0,this.lightPoint=[-10,4,20]}function tt(t,e,i,r){
this.x=Fe(t),this.y=Fe(e),this.height=Fe(r),this.width=Fe(i)}function et(t,e,i){var r=di.getCanvasCoord(t);e.base.callback.call(e,e.box?{x:r.x-e.box.x,y:r.y-e.box.y,name:i}:void 0)}function it(t){if(di.curPage.mouseCaptureWidget)return void et(t,di.curPage.mouseCaptureWidget,ct.EVENT_MOVE);var e=di.getWidget(t);null!==e&&e.base.index!==di.curPage.sel&&(di.curPage.sel=e.base.index,di.drawWidgets())}function rt(t){var e=di.getWidget(t);null!==e?et(t,e,ct.EVENT_PRESS):null!==di.curPage.mouseHandler&&di.curPage.mouseHandler()}function nt(t){di.curPage.mouseCaptureWidget&&(et(t,di.curPage.mouseCaptureWidget,ct.EVENT_RELEASE),
di.curPage.mouseCaptureWidget=null)}function ot(t){var e=di.getWidget(t);if(null!==e&&void 0!==e.onWheelEvent)return e.onWheelEvent(t),!1;for(var i=di.curPage.wheelHandlers,r=0;r<i.length;++r)if(i[r].box.inside(t))return i[r].handler(t),!1;return!0}function at(t){var e;if(di.curPage.widgets.length>0){if(e=!1,t.keyCode===Ee.DOM_VK_DOWN||t.keyCode===Ee.DOM_VK_RIGHT)di.curPage.sel=(di.curPage.sel+1)%di.curPage.widgets.length;else if(t.keyCode===Ee.DOM_VK_UP||t.keyCode===Ee.DOM_VK_LEFT)di.curPage.sel=(di.curPage.sel-1+di.curPage.widgets.length)%di.curPage.widgets.length;else if(t.keyCode===Ee.DOM_VK_RETURN||t.keyCode===Ee.DOM_VK_ENTER||t.keyCode===Ee.DOM_VK_SPACE){
var i=di.curPage.widgets[di.curPage.sel];i.base.callback.call(i)}else e=!0;if(e===!1)return di.drawWidgets(),e}return null!==di.curPage.keyHandler?di.curPage.keyHandler(t.keyCode):!0}function st(t){}function lt(t){t.preventDefault(),Re=t.touches[0].clientX-drawDiv.offsetLeft,Pe=t.touches[0].clientY-drawDiv.offsetTop,e={layerX:Re,layerY:Pe},rt(e)}function ut(t){t.preventDefault()}function ht(t){t.preventDefault()}function dt(){this.curPage=null,this.msgQueue=[],this.curMenuDraw=null,this.curMenuRemake=null,this.texth=42,this.has3dContent=!1,this.render3d=[],this.mainMenu=null,this.menuAnim=null,
window.setInterval(function(){di.checkMessageQueue()},200)}function ct(t,e){this.callback=t,this.index=e}function pt(t,e,i,r){this.base=i,this.text=t,this.tx=e.x,this.ty=e.y+e.height,this.box=e.expanded(Fe(di.em/4)).down(Fe(di.em/7)),this.group=r,this.group&&this.group.setBox(e.expanded(Fe(di.em/8)).down(Fe(di.em/7)))}function ft(t){var e=ui.createLinearGradient(t.x,t.y,t.x+t.width,t.y+t.height);return e.addColorStop(0,"#773cff"),e.addColorStop(1,"#f4204a"),e}function gt(t){return"#7c007e"}function mt(t,e,i,r,n,o){this.base=o,this.imgOn=t,this.imgOff=e,this.text=i,this.boxImg=n,this.box=n.expanded(Fe(di.em/4)),
this.isOn=r,this.toggleCallback=this.base.callback,this.base.callback=function(){this.isOn=!this.isOn,this.toggleCallback(this.isOn),this.draw(!0)}}function vt(t,e,i,r,n){this.base=r,this.img=t,this.text=e,this.boxImg=i,this.box=i.expanded(Fe(di.em/4)),this.group=n,this.group&&this.group.setBox(i.expanded(Fe(di.em/8)))}function wt(t,e,i,r,n,o){this.base=o,o.box=n,this.vmin=t,this.vmax=e,this.step=i,this.value=r,this.box=n,this.valueChanged=o.callback,this.base.callback=this.onevent,this.clearBox=n.expanded(2).widen(.5*di.en),this.valueChanged(this.value)}function xt(t,e,i,r,n){this.base=n,n.box=r,
this.box=r,this.total=t,this.part=e,this.valueChanged=n.callback,this.base.callback=this.onevent,this.value=i,this.clearBox=r.expanded(2),this.h=0,this.pressY=null,this.pressH=null}function yt(t){this.sel=t}function bt(t,e){this.id=e,this.com=t}function _t(t,e){this.box=e,this.allwidgets=t,this.d=[],this.length=0,this.translateY=0,e&&(this.drawScroll={x:e.x+e.width+12,y:e.y-7,height:e.height+14})}function St(t){this.anglex=0,this.angley=0,this.box=t}function Mt(t){this.box=t}function Dt(t){this.box=t,this.move=0,this.colors=[];for(var e=0;e<Me.length;++e)e!==Ke.userIndex&&this.colors.push(Me[e].model);
}function At(t){this.anglex=0,this.angley=0,this.color=we.x(t.modelColor,1.5),this.count=Ge.userLivesCount,this.activeDeath=void 0,this.activeOneUp=void 0,this.lightFactor=1,this.pendingDeath=!1;var e=$e.viewportWidth/$e.viewportHeight;this.prMatrix=ye.ortho(0,e,1,0,.1,100)}function Et(e){var i,r;if("number"==typeof e?(i=We[e],r=e):(i=e,r=-1),Qe("** START"+e),void 0===i||void 0===qe[i.worldModel]||void 0===qe[i.worldModel].model)throw new Error("not implemented");ni={ready:!1},ni.model=qe[i.worldModel].model,Ut(),i.speed||(i.speed=1),Ge.currentLevelNum=r,Ge.currentLevel=i,ai=[];for(var n=0;n<i.numPlayers;++n){
var o=t(0,ni.model.vtx.length-1),a=new g(n,qe.bike,o);n!==Ke.userIndex&&(a.ai=new N(a,i.ai)),ai.push(a)}Ke.userIndex>=0?(oi=ai[Ke.userIndex],oi.turnCallback=Nt):oi=ai[0];for(var s in ai)ai[s].init();ni.map=new he,i.view?i.view===Ve.Inside?si=new Z:i.view===Ve.FirstPerson&&(si=new J):si=new j(worldModels[i.worldModel].eyeDist),si.moveUpdate(oi),Ge.isDemo?Ge.setAbsPaused(!1):(Ge.setAbsPaused(!0),Ge._startPause=!0),Ye={handler:null,called:!1},di.clearMessages(),0===r&&di.addMessage("Use the arrow keys to start the game",dt.MSGID_START_ARROWS),ni.staticDraw={lives:new At(oi)},ni.bonuses=[],ni.background=new jt(qe.background,.28*ni.model.bbox.size),
ni.ready=!0,de(!0),di.drawGameState(),Rt()}function Tt(){this.currentLevelNum=0,this.currentLevel=null,this.userLivesCount=3,this.isDemo=!1,this._paused=0,this._startPause=!1;var t=$.cookie("enableSound");this.soundEnabled=null!==t?"true"===t:!0}function Rt(){T(ei,li)}function Pt(t){Ge.currentLevelNum=0,Ge.userLivesCount=3,Et(t?t:0)}function It(){Ye.called=!0,ni.staticDraw.lives.startDeath(),Qe("lives remaining: "+Ge.userLivesCount),Ge.userLivesCount>0?di.lifeEndScreen(Ge.currentLevel,Ge.currentLevelNum):di.gameOverScreen(Ge.currentLevel,Ge.currentLevelNum)}function kt(){Ye.called=!0,Ke.disableEndLevel||(Ge.setAbsPaused(!0),
di.levelComplete(Ge.currentLevelNum,Ge.currentLevel))}function Lt(t,e){if(G(t,e),Ht(t),Ct(t,e),!Ke.disableDeath)if(t.curStepFrac=1,t.wall.deathEnd(t),t.alive=!1,q(t),t===oi)--Ge.userLivesCount,Ye.called===!1&&(Ye={handler:It,called:!1});else{for(var i=0,r=0;r<ai.length;++r)ai[r].alive&&++i;1===i&&Ye.called===!1&&(Ye={handler:kt,called:!1})}}function Ct(t,e){var i;if(e>=100){var r=e-100;i=r===t.id?t.prettyName()+" collided with its own wall":t.prettyName()+" collided with wall of "+ai[r].prettyName()}else{var r=e;i=t.prettyName()+" collided with "+ai[r].prettyName()}di.addMessage(i),Qe(i+" on "+t.point);
}function Ot(){var e,i,r,n=0;do{if(n++>10)return[null];if(e=t(0,ni.model.vtx.length-1),void 0===ni.map.get(e)){r=ni.model.nei[e].t,i=!0;for(var o in r)i|=void 0===ni.map.get(r[o])}}while(!i);var a=[e];for(var o in r)a.push(r[o]);return a}function Ft(t,e){this.numChannels=e,this.curChannel=0,this.players=[],this.players[0]=t;for(var i=0;i<this.numChannels;++i){var r=new Audio;r.onerror=function(t){Qe("  SND ERROR"+t.currentTarget.error.code)},r.src=t.currentSrc,r.load(),this.players[i]=r}}function Bt(){ze={},ze.turn=new Ft($("#turnSound1")[0],5),ze.start=new Ft($("#powerupSound")[0],1),ze.crash=new Ft($("#crashSound")[0],2),
ze.bonus=new Ft($("#coinUp")[0],1)}function Nt(t){Ge.soundEnabled&&ze.turn.play(1)}function Ut(){Ge.soundEnabled&&ze.start.play(.4)}function Ht(t){if(Ge.soundEnabled){var e=t===oi?1:.2;ze.crash.play(e)}}function Vt(t){if(Ge.soundEnabled){var e=t===oi?1:.2;ze.bonus.play(e)}}function Wt(t,e){return null===e?(delete Xe.items[t],void(Xe.ondone&&0===Object.keys(Xe.items).length&&(Xe.onprogress=null,Xe.ondone(),Xe.ondone=null))):void(Xe.items[t]=e)}function Kt(t){if(0===Object.keys(Xe.items).length)return void t();di.loadingScreen(0),Xe.ondone=t;Xe.onprogress=function(t){return di.loadingScreen(t),!1;
}}function Gt(t,e){Wt(t,"processing");var i=qe[t],r={},n=(new Date).getTime();Qe("start "+t),O(i.input,r),L(r,e,function(){i.model=r,Qe("done "+t+" "+((new Date).getTime()-n)),Wt(t,null)},function(t){return Xe.onprogress?Xe.onprogress(t):!0})}function Yt(t){qe[t]&&qe[t].model&&(Qe("deleting "+t),delete qe[t].model)}function zt(t,e,i){var r={input:e,name:t};qe[t]=r,i.gridProc?Gt(t,i.async):Wt(t,null)}function qt(t,e,i){if(We[t]){var r=We[t].worldModel;return void 0===qe[r]||void 0===qe[r].input?void $t(worldModels[r].file,"none",r,zt,{gridProc:e,async:i}):void(void 0===qe[r].model&&e&&Gt(r,i))}}
function Xt(t,e,i){var r=We[t];if(void 0===r)throw new Error("level not found");if(void 0!==qe[r.worldModel]&&void 0!==qe[r.worldModel].model)return void(i&&i());for(var n=!0,o=0;t>o;++o)Yt(We[o].worldModel);for(var o=t+e;o<We.length;++o)Yt(We[o].worldModel);for(var o=0;e>o;++o)qt(t+o,!0,n);i&&Kt(i)}function Qt(t,e){qe[t]=e,Wt(t,null),qe.life&&qe.bike&&(qe._ready=!0,n("rcsinit"))}function $t(t,e,i,r,n){Wt(i,"loading");$.getJSON(t,{},function(t){if("indexed"===e){var o={};P(t,o),r(i,o,n)}else if("inlined"===e){var o={};I(t,o),r(i,o,n)}else{if("none"!==e)throw"unknown load method";r(i,t,n)}})}function jt(t,e){
this.model=t,this.scale=e,this.time=0}function Zt(t){var e=[-5.28,-1.72,-2.78,0,0,-6.21,0,-5.55,-2.78,5.28,-1.72,-2.78,3.26,-4.49,2.78,0,0,6.21,-3.26,-4.49,2.78,5.28,1.72,2.78,-5.28,1.72,2.78,-3.26,4.49,-2.78,3.26,4.49,-2.78,0,5.55,2.78],i=[0,1,2,2,3,4,4,5,6,7,5,4,2,1,3,7,4,3,0,8,9,2,6,0,3,1,10,5,8,6,9,1,0,1,9,10,10,9,11,8,11,9,11,7,10,4,6,2,8,0,6,7,11,5,10,7,3,5,11,8];t.vertexBuffer=h.Data($e.ARRAY_BUFFER,new Float32Array(e),$e.STATIC_DRAW,3),t.triangles=h.Data($e.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),$e.STATIC_DRAW,1)}function Jt(t,e,i){t.triangles&&(t.triangles.bind(),$e.drawElements($e.TRIANGLES,t.triangles.numItems,t.triangles.type,0)),
t.triangleStrip&&(t.triangleStrip.bind(),$e.drawElements($e.TRIANGLE_STRIP,t.triangleStrip.numItems,t.triangleStrip.type,0)),t.lines&&($e.lineWidth(3),t.lines.bind(),$e.drawElements($e.LINES,t.lines.numItems,t.lines.type,0)),t.trianglesInline&&(t.diffuseColor?i.setColor(t.diffuseColor[0],t.diffuseColor[1],t.diffuseColor[2]):e&&i.setColorv(e),t.vertexBuffer.bind(),$e.vertexAttribPointer(i.vertexPositionAttribute,t.vertexBuffer.itemSize,$e.FLOAT,!1,0,0),t.vNormalBuffer.bind(),$e.vertexAttribPointer(i.vertexNormalAttribute,t.vNormalBuffer.itemSize,$e.FLOAT,!1,0,0),$e.drawArrays($e.TRIANGLES,0,t.vertexBuffer.numItems));
}function te(t,e){var i=u.current;if(t.vertexBuffer&&(t.vertexBuffer.bind(),$e.vertexAttribPointer(i.vertexPositionAttribute,t.vertexBuffer.itemSize,$e.FLOAT,!1,0,0)),t.vNormalBuffer&&(t.vNormalBuffer.bind(),$e.vertexAttribPointer(i.vertexNormalAttribute,t.vNormalBuffer.itemSize,$e.FLOAT,!1,0,0)),i.setMatrixUniforms(),Jt(t,void 0,i),t.groups)for(var r in t.groups)Jt(t.groups[r],e,i)}function ee(t,e,i){var r=xe.create([t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]]);return xe.toMat4(r)}function ie(t){var e=t.curStepFrac,i=we.linearMix(ni.model.vtx[t.point],ni.model.vtx[t.last.point],e);be.translate(i);
var r=t.getBikeOrient(),n=ee(t.rightHand,r.normal,r.forward);be.multMatrix(n)}function re(){var t=!0;if(ii.setUseLight(t),t){var e={rgb:[.2,.2,.2]};$e.uniform3f(ii.ambientColorUniform,e.rgb[0],e.rgb[1],e.rgb[2]);var i=si.getLight();$e.uniform3f(ii.pointLightingLocationUniform,i[0],i[1],i[2]);var r={rgb:[.8,.8,.8]};$e.uniform3f(ii.pointLightingDiffuseColorUniform,r.rgb[0],r.rgb[1],r.rgb[2])}}function ne(){$e.viewport(0,0,$e.viewportWidth,$e.viewportHeight),$e.clear($e.COLOR_BUFFER_BIT|$e.DEPTH_BUFFER_BIT),++Je,_e.perspective(45,ei.width/ei.height,.1+si.addNearClip,100),re(),be.loadIdentity(),u.use(ii);
for(var t in ni.staticDraw)ni.staticDraw[t].render();var e=si.getCamera();be.multMatrix(ye.lookAt(e.eye,e.toPoint,e.upDir)),Ke.debug&&be.multMatrix(Ae.rotationMatrix),ii.setColor(1,1,1),ii.setTwoSided(e.twoSided),te(ni.model);for(var i=0;i<ai.length;++i){ii.setTwoSided(!1);var r=ai[i];if(r.wall.standing){var n=r.alive&&r.wall.fracExtend(r),o=r.trailColor;if(r.sfx.wall_decent){var a=.6*r.sfx.wall_decent.brightness;o=we.nadd(o,[a,a,a])}ii.setColorv(o),ii.setMatrixUniforms(),r.wall.vtxBuf.bind(),$e.vertexAttribPointer(ii.vertexPositionAttribute,r.wall.vtxBuf.itemSize,$e.FLOAT,!1,0,0),$e.bindBuffer($e.ARRAY_BUFFER,null),
r.wall.normalsBuf.bind(),$e.vertexAttribPointer(ii.vertexNormalAttribute,r.wall.normalsBuf.itemSize,$e.FLOAT,!1,0,0),r.wall.idxRbuf.bind(),$e.drawElements($e.TRIANGLE_STRIP,r.wall.idxRbuf.numItems,$e.UNSIGNED_SHORT,0),r.wall.idxLbuf.bind(),$e.drawElements($e.TRIANGLE_STRIP,r.wall.idxLbuf.numItems,$e.UNSIGNED_SHORT,0),r.wall.idxTbuf.bind(),$e.drawElements($e.TRIANGLE_STRIP,r.wall.idxTbuf.numItems,$e.UNSIGNED_SHORT,0),n&&r.wall.backtrackRawPoint()}r.alive&&(ii.setTwoSided(!0),be.pushMatrix(),ie(r),r.alive&&(be.rotateX(-90),si.bikeFlip&&be.rotateY(180),be.scale(ni.model.scale.BIKE_SCALE),be.translate([0,2,1.3]),
te(r.model,r.modelColor)),be.popMatrix())}for(var i=0;i<ai.length;++i){var r=ai[i];r.sfx.explode&&(be.pushMatrix(),ie(r),r.sfx.explode.draw(),be.popMatrix())}for(var s in ni.bonuses)ni.bonuses[s].draw();u.use(ri),ni.background.draw(),u.use(ii)}function oe(t){var e=t.point,i=t.selDir.move.call(t),r=ni.map.getPiece(t.point);if(void 0!==r)if(r>=1e3){var n=r-1e3;ni.bonuses[n]&&ni.bonuses[n].action(t)}else Lt(t,r);return++t.stepCount,ni.map.set(e,t.id+100,t.stepCount),void 0===r&&ni.map.set(t.point,t.id,t.stepCount),{dist:i,collide:r}}function ae(t){for(var e=!1,i=0;i<ai.length;++i){var r=ai[i];if(r.alive){
var n=0;for(Ge.isPaused()||(n=ni.model.scale.BASE_SPEED*Ge.currentLevel.speed*t),r.dNow2Last+=n,r.dNow2Point-=n,r.lastMadeMoves=0;r.dNow2Point<0;){r.ai&&r.ai.moveControl(ni);var o=oe(r);if(r.dNow2Last=-r.dNow2Point,r.dNow2Point+=o.dist,r.lastMvDist=o.dist,e=!0,++r.lastMadeMoves,o.collide)break}r.alive&&!Ge.isPaused()&&(r.curStepFrac=r.dNow2Last/r.lastMvDist),si.moveUpdate(r),r.lastMadeMoves>1&&Qe("made "+r.lastMadeMoves+" moves elapsed="+t)}for(var a in r.sfx)r.sfx[a]&&(r.sfx[a].advance(t),e=!0)}for(var a in ni.staticDraw)ni.staticDraw[a].advance(t);for(var s in ni.bonuses)ni.bonuses[s].advance(t)||delete ni.bonuses[s];
return(!Ge.isPaused()||Ge._startPause)&&ni.background.advance(t),di.menuAnim&&di.menuAnim(t),e}function se(){WebGLUtils.requestAnimationFrame(ei,se);var t=(new Date).getTime(),e=0;if(0==Ze)return Qe("RESET time"),void(Ze=t);if(e=t-Ze,e>40&&(e=40),Ze=t,M(oi),di.has3dContent&&di.draw3d(e),ni.ready&&qe._ready&&hi){ae(e);hi&&ne(),Ke.printFps&&je(e)}}function le(){if(ni.ready&&qe._ready&&hi&&!Ge.isPaused()){var t=ni.bonuses.length>0?.2:3;r(t)&&X()}}function ue(t){return($e=WebGLUtils.setupWebGL(t,{antialias:!0,stencil:!1,alpha:!0}))?($e.viewportWidth=t.width,$e.viewportHeight=t.height,$e.clearColor(0,0,0,1),
$e.clearDepth(1),$e.blendFunc($e.SRC_ALPHA,$e.ONE_MINUS_SRC_ALPHA),$e.enable($e.DEPTH_TEST),$e.depthFunc($e.LEQUAL),n("init"),!0):!1}function he(){this.data=[]}function de(t){t!==hi&&(t?(hi=!0,Ze=0):($e.viewport(0,0,ei.width,ei.height),$e.clear($e.COLOR_BUFFER_BIT|$e.DEPTH_BUFFER_BIT),hi=!1))}function ce(t,e){var i=20;drawDiv=document.getElementById("canvas-container");var r=Math.round(.94*window.innerHeight/.7/i)*i,n=Math.round(.94*window.innerWidth/i)*i,o=Math.min(r,n);if(o!==ei.width||e){600>o&&(o=600),$e.viewportWidth=ei.width=li.width=o;var a=.7*o;drawDiv.style.height=a+"px",drawDiv.style.width=o+"px",
$e.viewportHeight=ei.height=li.height=a,di.resizeAdjust(li.width,li.height),Qe("canvas resized: "+ei.width+" x "+ei.height)}}function pe(t,e){$e.bindTexture($e.TEXTURE_2D,e),$e.texImage2D($e.TEXTURE_2D,0,$e.RGBA,$e.RGBA,$e.UNSIGNED_BYTE,t),$e.texParameteri($e.TEXTURE_2D,$e.TEXTURE_MAG_FILTER,$e.LINEAR),$e.texParameteri($e.TEXTURE_2D,$e.TEXTURE_MIN_FILTER,$e.LINEAR),$e.texParameteri($e.TEXTURE_2D,$e.TEXTURE_WRAP_S,$e.CLAMP_TO_EDGE),$e.texParameteri($e.TEXTURE_2D,$e.TEXTURE_WRAP_T,$e.CLAMP_TO_EDGE)}function fe(){ci=$e.createTexture(),img=new Image,img.onload=function(){pe(img,ci)},img.src="img/tex2d.jpg";
}function ge(){Ge.userLivesCount=10}function me(){if(document.getElementById("shadersFrame").src="shaders.html",ei=document.getElementById("game-canvas"),ue(ei)){if(li=document.getElementById("ctrl-canvas"),ui=li.getContext("2d"),null==ui)return void alert("failed creating 2d context");ce(null,!0),di.showStartScreen(ui),shaderFrame=$("#shadersFrame").contents(),ii.init(shaderFrame.find("#phong-fs"),shaderFrame.find("#phong-vs")),ii.initNormParams(),ri.init(shaderFrame.find("#bkg-3dtex-fs"),shaderFrame.find("#bkg-vs")),ri.initBkgParams(),u.use(ii),window.onresize=ce,fe(),$("#fpsui").text("FPS: 0"),
$t("models/bikePlayer2.json","inlined","bike",Qt),$t("models/lifeWheel.json","indexed","life",Qt),qe.explode={ring:{}},B(qe.explode),qe.background={},Zt(qe.background),Bt(),WebGLUtils.requestAnimationFrame(ei,se),setInterval(le,1e3)}}jQuery.cookie=function(t,e,i){if("undefined"==typeof e){var r=null;if(document.cookie&&""!=document.cookie)for(var n=document.cookie.split(";"),o=0;o<n.length;o++){var a=jQuery.trim(n[o]);if(a.substring(0,t.length+1)==t+"="){r=decodeURIComponent(a.substring(t.length+1));break}}return r}i=i||{},null===e&&(e="",i.expires=-1);var s="";if(i.expires&&("number"==typeof i.expires||i.expires.toUTCString)){
var l;"number"==typeof i.expires?(l=new Date,l.setTime(l.getTime()+24*i.expires*60*60*1e3)):l=i.expires,s="; expires="+l.toUTCString()}var u=i.path?"; path="+i.path:"",h=i.domain?"; domain="+i.domain:"",d=i.secure?"; secure":"";document.cookie=[t,"=",encodeURIComponent(e),s,u,h,d].join("")};var ve={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(t){for(var e=0;e<t.length;e++){
var i=t[e].string,r=t[e].prop;if(this.versionSearchString=t[e].versionSearch||t[e].identity,i){if(-1!=i.indexOf(t[e].subString))return t[e].identity}else if(r)return t[e].identity}},searchVersion:function(t){var e=t.indexOf(this.versionSearchString);if(-1!=e)return parseFloat(t.substring(e+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,
identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"
}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};ve.init(),WebGLUtils=function(){var t,e,i=function(t,e){return'<div style="background-color: #EEE; width: 100%; height: 100%; text-align:center;" class="inframe"><div style="width: 80%; height: 100%; margin: auto; display:table;"><p style="font:bold 28px sans-serif; margin:10px 0 10px 0">'+t+'</p><div style="font-size: 18px; margin:0">'+e+"</div></div></div>";
},r="Your browser does not support WebGL",n="http://www.google.com/chrome",o="http://getfirefox.com",a="<div style='float:left; width:150px'><a href='"+o+"' target=_blank><img src='img/firefox_icon128.png'><br/>Get firefox</a></div>",s="<div style='float:left; width:150px'><a href='"+n+"' target=_blank><img src='img/chromelogo128.png'><br/>Get chrome</a></div>",l='<div style="margin:10px auto 0 auto; display:table;">'+a+s+"</div>",u='<div style="margin:10px auto 0 auto; display:table;">'+s+"</div>",h='<div style="margin:10px auto 0 auto; display:table;">'+a+"</div>",d="To play CycleBlob please use <a href='"+n+"' target=_blank>Google Chrome</a> or <a href='"+o+"' target=_blank>Mozilla Firefox</a>",c='<iframe title="YouTube video player" width="640" height="390" src="http://www.youtube.com/embed/amFozFKhmxc?rel=0" frameborder="0" allowfullscreen></iframe>',p="Check this website: <a href='http://get.webgl.org/'>http://get.webgl.org/</a> for more information.",f="<br/>"+p+"<br/><br/>"+c,g="Firefox "+ve.version+" does not supprot WebGL<br/>To play CycleBlob please upgrade to the latest version of <a href='"+o+"' target=_blank>Firefox</a> (4.0 and above) or get <a href='"+n+"' target=_blank>Google Chrome</a><br/>"+l+f,m="Chrome "+ve.version+" does not support WebGL<br/>To play CycleBlob please upgrade to the latest version of <a href='"+n+"' target=_blank>Chrome</a> (9.0 and above) or get <a href='"+o+"' target=_blank>Mozilla Firefox</a><br/>"+l+f,v=d+f,w="Microsoft Internet Explorer (MSIE) does not support WebGL yet.<br/>"+d+"<br/>"+l+f,x="Your version of Firefox ("+ve.version+") is supposed to support WebGL but an error occured while trying to use it</br>Things you might try to do to fix this:</br><ul style='text-align:left; margin-bottom:0'><li>Write in the address 'about:config' in the address bar and press Enter. Filter for 'WebGL' in the config page and make sure it is not disabled.</li><li>In the same page (about:config), set 'webgl.force-enabled' to 'true'</li><li>Check for messages or errors at the very bottom of the 'about:support' page</li><li>Update the display drivers of your computer. Some older drivers are known not to work properly.</li><li>"+p+"</li><li>Try <a href='"+n+"' target=_blank>Google Chrome</a>.</li></ul>"+u+"<br/>"+c,y="Your version of Chrome ("+ve.version+") is supposed to support WebGL but an error occured while trying to use it</br>Things you might try to do to fix this:</br><ul style='text-align:left; margin-bottom:0'><li>Update the display drivers of your computer. Some older drivers are known not to work properly.</li><li>Write in the address 'about:gpu' in the address bar, press Enter and see if you detect some sort of error which prevents using hardware acceleration</li><li>"+p+"</li><li>Try <a href='"+o+"' target=_blank>Mozilla Firefox</a>.</li></ul>"+h+"<br/>"+c,b="An Unknown error occured while initializing WebGL",_="Your browser appears to support WebGL but there was an error using it<br/>"+p+"<br/>"+c,S=function(t,e,n){
function o(){var e=t.parentNode;if(e){var n;n="Explorer"==ve.browser?i(r,w):"Firefox"==ve.browser?ve.version<4?i(r,g):i(b,x):"Chrome"==ve.browser?ve.version<9?i(r,m):i(b,y):window.WebGLRenderingContext?i(b,_):i(r,v),e.innerHTML=n,e.style.height=null}}n=n||o,t.addEventListener&&t.addEventListener("webglcontextcreationerror",function(t){n(t.statusMessage)},!1);var a=M(t,e);return a||n(),a},M=function(t,e){for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],r=null,n=0;n<i.length;++n){try{r=t.getContext(i[n],e)}catch(t){}if(r)break}return r},D=function(){return e||(e=function(){for(var t=["animationTime","webkitAnimationTime","mozAnimationTime","oAnimationTime","msAnimationTime"],e=0;e<t.length;++e){
var i=t[e];if(window[i])return function(){return window[i]}}return function(){return(new Date).getTime()}}()),e()},A=function(e,i){t||(t=function(){for(var t=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"],e=0;e<t.length;++e){var i=t[e];if(window[i])return function(t){return function(e,i){window[t].call(window,i,e)}}(i)}return function(t,e){window.setTimeout(e,1e3/70)}}()),t(e,i)};return{animationTime:D,create3DContext:M,requestAnimationFrame:A,setupWebGL:S}}(),glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:"undefined"!=typeof WebGLFloatArray?WebGLFloatArray:Array;
var we={};we.create=function(t){var e=new glMatrixArrayType(3);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2]),e},we.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},we.add=function(t,e,i){return i&&t!=i?(i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t)},we.subtract=function(t,e,i){return i&&t!=i?(i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i):(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t)},we.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},we.scale=function(t,e,i){return i&&t!=i?(i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i):(t[0]*=e,t[1]*=e,t[2]*=e,
t)},we.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],n=t[2],o=Math.sqrt(i*i+r*r+n*n);return o?1==o?(e[0]=i,e[1]=r,e[2]=n,e):(o=1/o,e[0]=i*o,e[1]=r*o,e[2]=n*o,e):(e[0]=0,e[1]=0,e[2]=0,e)},we.cross=function(t,e,i){i||(i=t);var r=t[0],n=t[1];t=t[2];var o=e[0],a=e[1];return e=e[2],i[0]=n*e-t*a,i[1]=t*o-r*e,i[2]=r*a-n*o,i},we.length=function(t){var e=t[0],i=t[1];return t=t[2],Math.sqrt(e*e+i*i+t*t)},we.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},we.direction=function(t,e,i){i||(i=t);var r=t[0]-e[0],n=t[1]-e[1];return t=t[2]-e[2],(e=Math.sqrt(r*r+n*n+t*t))?(e=1/e,i[0]=r*e,i[1]=n*e,i[2]=t*e,
i):(i[0]=0,i[1]=0,i[2]=0,i)},we.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+"]"};var xe={};xe.create=function(t){var e=new glMatrixArrayType(9);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9]),e},xe.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},xe.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},xe.toMat4=function(t,e){return e||(e=ye.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],
e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},xe.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+"]"};var ye={};ye.create=function(t){var e=new glMatrixArrayType(16);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e},ye.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],
e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},ye.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},ye.transpose=function(t,e){if(!e||t==e){var i=t[1],r=t[2],n=t[3],o=t[6],a=t[7],s=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=i,t[6]=t[9],t[7]=t[13],t[8]=r,t[9]=o,t[11]=t[14],t[12]=n,t[13]=a,t[14]=s,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},ye.determinant=function(t){
var e=t[0],i=t[1],r=t[2],n=t[3],o=t[4],a=t[5],s=t[6],l=t[7],u=t[8],h=t[9],d=t[10],c=t[11],p=t[12],f=t[13],g=t[14];return t=t[15],p*h*s*n-u*f*s*n-p*a*d*n+o*f*d*n+u*a*g*n-o*h*g*n-p*h*r*l+u*f*r*l+p*i*d*l-e*f*d*l-u*i*g*l+e*h*g*l+p*a*r*c-o*f*r*c-p*i*s*c+e*f*s*c+o*i*g*c-e*a*g*c-u*a*r*t+o*h*r*t+u*i*s*t-e*h*s*t-o*i*d*t+e*a*d*t},ye.inverse=function(t,e){e||(e=t);var i=t[0],r=t[1],n=t[2],o=t[3],a=t[4],s=t[5],l=t[6],u=t[7],h=t[8],d=t[9],c=t[10],p=t[11],f=t[12],g=t[13],m=t[14],v=t[15],w=i*s-r*a,x=i*l-n*a,y=i*u-o*a,b=r*l-n*s,_=r*u-o*s,S=n*u-o*l,M=h*g-d*f,D=h*m-c*f,A=h*v-p*f,E=d*m-c*g,T=d*v-p*g,R=c*v-p*m,P=1/(w*R-x*T+y*E+b*A-_*D+S*M);
return e[0]=(s*R-l*T+u*E)*P,e[1]=(-r*R+n*T-o*E)*P,e[2]=(g*S-m*_+v*b)*P,e[3]=(-d*S+c*_-p*b)*P,e[4]=(-a*R+l*A-u*D)*P,e[5]=(i*R-n*A+o*D)*P,e[6]=(-f*S+m*y-v*x)*P,e[7]=(h*S-c*y+p*x)*P,e[8]=(a*T-s*A+u*M)*P,e[9]=(-i*T+r*A-o*M)*P,e[10]=(f*_-g*y+v*w)*P,e[11]=(-h*_+d*y-p*w)*P,e[12]=(-a*E+s*D-l*M)*P,e[13]=(i*E-r*D+n*M)*P,e[14]=(-f*b+g*x-m*w)*P,e[15]=(h*b-d*x+c*w)*P,e},ye.toMat3=function(t,e){return e||(e=xe.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},ye.toInverseMat3=function(t,e){var i=t[0],r=t[1],n=t[2],o=t[4],a=t[5],s=t[6],l=t[8],u=t[9],h=t[10],d=h*a-s*u,c=-h*o+s*l,p=u*o-a*l,f=i*d+r*c+n*p;
return f?(f=1/f,e||(e=xe.create()),e[0]=d*f,e[1]=(-h*r+n*u)*f,e[2]=(s*r-n*a)*f,e[3]=c*f,e[4]=(h*i-n*l)*f,e[5]=(-s*i+n*o)*f,e[6]=p*f,e[7]=(-u*i+r*l)*f,e[8]=(a*i-r*o)*f,e):null},ye.multiply=function(t,e,i){i||(i=t);var r=t[0],n=t[1],o=t[2],a=t[3],s=t[4],l=t[5],u=t[6],h=t[7],d=t[8],c=t[9],p=t[10],f=t[11],g=t[12],m=t[13],v=t[14];t=t[15];var w=e[0],x=e[1],y=e[2],b=e[3],_=e[4],S=e[5],M=e[6],D=e[7],A=e[8],E=e[9],T=e[10],R=e[11],P=e[12],I=e[13],k=e[14];return e=e[15],i[0]=w*r+x*s+y*d+b*g,i[1]=w*n+x*l+y*c+b*m,i[2]=w*o+x*u+y*p+b*v,i[3]=w*a+x*h+y*f+b*t,i[4]=_*r+S*s+M*d+D*g,i[5]=_*n+S*l+M*c+D*m,i[6]=_*o+S*u+M*p+D*v,
i[7]=_*a+S*h+M*f+D*t,i[8]=A*r+E*s+T*d+R*g,i[9]=A*n+E*l+T*c+R*m,i[10]=A*o+E*u+T*p+R*v,i[11]=A*a+E*h+T*f+R*t,i[12]=P*r+I*s+k*d+e*g,i[13]=P*n+I*l+k*c+e*m,i[14]=P*o+I*u+k*p+e*v,i[15]=P*a+I*h+k*f+e*t,i},ye.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],n=e[1];return e=e[2],i[0]=t[0]*r+t[4]*n+t[8]*e+t[12],i[1]=t[1]*r+t[5]*n+t[9]*e+t[13],i[2]=t[2]*r+t[6]*n+t[10]*e+t[14],i},ye.multiplyVec4=function(t,e,i){i||(i=e);var r=e[0],n=e[1],o=e[2];return e=e[3],i[0]=t[0]*r+t[4]*n+t[8]*o+t[12]*e,i[1]=t[1]*r+t[5]*n+t[9]*o+t[13]*e,i[2]=t[2]*r+t[6]*n+t[10]*o+t[14]*e,i[3]=t[3]*r+t[7]*n+t[11]*o+t[15]*e,i},ye.translate=function(t,e,i){
var r=e[0],n=e[1];if(e=e[2],!i||t==i)return t[12]=t[0]*r+t[4]*n+t[8]*e+t[12],t[13]=t[1]*r+t[5]*n+t[9]*e+t[13],t[14]=t[2]*r+t[6]*n+t[10]*e+t[14],t[15]=t[3]*r+t[7]*n+t[11]*e+t[15],t;var o=t[0],a=t[1],s=t[2],l=t[3],u=t[4],h=t[5],d=t[6],c=t[7],p=t[8],f=t[9],g=t[10],m=t[11];return i[0]=o,i[1]=a,i[2]=s,i[3]=l,i[4]=u,i[5]=h,i[6]=d,i[7]=c,i[8]=p,i[9]=f,i[10]=g,i[11]=m,i[12]=o*r+u*n+p*e+t[12],i[13]=a*r+h*n+f*e+t[13],i[14]=s*r+d*n+g*e+t[14],i[15]=l*r+c*n+m*e+t[15],i},ye.scale=function(t,e,i){var r=e[0],n=e[1];return e=e[2],i&&t!=i?(i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3]*r,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,
i[7]=t[7]*n,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i):(t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r,t[4]*=n,t[5]*=n,t[6]*=n,t[7]*=n,t[8]*=e,t[9]*=e,t[10]*=e,t[11]*=e,t)},ye.rotate=function(t,e,i,r){var n=i[0],o=i[1];i=i[2];var a=Math.sqrt(n*n+o*o+i*i);if(!a)return null;1!=a&&(a=1/a,n*=a,o*=a,i*=a);var s=Math.sin(e),l=Math.cos(e),u=1-l;e=t[0],a=t[1];var h=t[2],d=t[3],c=t[4],p=t[5],f=t[6],g=t[7],m=t[8],v=t[9],w=t[10],x=t[11],y=n*n*u+l,b=o*n*u+i*s,_=i*n*u-o*s,S=n*o*u-i*s,M=o*o*u+l,D=i*o*u+n*s,A=n*i*u+o*s;return n=o*i*u-n*s,o=i*i*u+l,r?t!=r&&(r[12]=t[12],
r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=e*y+c*b+m*_,r[1]=a*y+p*b+v*_,r[2]=h*y+f*b+w*_,r[3]=d*y+g*b+x*_,r[4]=e*S+c*M+m*D,r[5]=a*S+p*M+v*D,r[6]=h*S+f*M+w*D,r[7]=d*S+g*M+x*D,r[8]=e*A+c*n+m*o,r[9]=a*A+p*n+v*o,r[10]=h*A+f*n+w*o,r[11]=d*A+g*n+x*o,r},ye.rotateX=function(t,e,i){var r=Math.sin(e);e=Math.cos(e);var n=t[4],o=t[5],a=t[6],s=t[7],l=t[8],u=t[9],h=t[10],d=t[11];return i?t!=i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[4]=n*e+l*r,i[5]=o*e+u*r,i[6]=a*e+h*r,i[7]=s*e+d*r,i[8]=n*-r+l*e,i[9]=o*-r+u*e,i[10]=a*-r+h*e,i[11]=s*-r+d*e,i},ye.rotateY=function(t,e,i){
var r=Math.sin(e);e=Math.cos(e);var n=t[0],o=t[1],a=t[2],s=t[3],l=t[8],u=t[9],h=t[10],d=t[11];return i?t!=i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*e+l*-r,i[1]=o*e+u*-r,i[2]=a*e+h*-r,i[3]=s*e+d*-r,i[8]=n*r+l*e,i[9]=o*r+u*e,i[10]=a*r+h*e,i[11]=s*r+d*e,i},ye.rotateZ=function(t,e,i){var r=Math.sin(e);e=Math.cos(e);var n=t[0],o=t[1],a=t[2],s=t[3],l=t[4],u=t[5],h=t[6],d=t[7];return i?t!=i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*e+l*r,i[1]=o*e+u*r,i[2]=a*e+h*r,i[3]=s*e+d*r,i[4]=n*-r+l*e,
i[5]=o*-r+u*e,i[6]=a*-r+h*e,i[7]=s*-r+d*e,i},ye.frustum=function(t,e,i,r,n,o,a){a||(a=ye.create());var s=e-t,l=r-i,u=o-n;return a[0]=2*n/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*n/l,a[6]=0,a[7]=0,a[8]=(e+t)/s,a[9]=(r+i)/l,a[10]=-(o+n)/u,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(o*n*2)/u,a[15]=0,a},ye.perspective=function(t,e,i,r,n){return t=i*Math.tan(t*Math.PI/360),e=t*e,ye.frustum(-e,e,-t,t,i,r,n)},ye.ortho=function(t,e,i,r,n,o,a){a||(a=ye.create());var s=e-t,l=r-i,u=o-n;return a[0]=2/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(t+e)/s,a[13]=-(r+i)/l,a[14]=-(o+n)/u,
a[15]=1,a},ye.lookAt=function(t,e,i,r){r||(r=ye.create());var n=t[0],o=t[1];t=t[2];var a=i[0],s=i[1],l=i[2];i=e[1];var u=e[2];if(n==e[0]&&o==i&&t==u)return ye.identity(r);var h,d,c,p;return i=n-e[0],u=o-e[1],e=t-e[2],p=1/Math.sqrt(i*i+u*u+e*e),i*=p,u*=p,e*=p,h=s*e-l*u,l=l*i-a*e,a=a*u-s*i,(p=Math.sqrt(h*h+l*l+a*a))?(p=1/p,h*=p,l*=p,a*=p):a=l=h=0,s=u*a-e*l,d=e*h-i*a,c=i*l-u*h,(p=Math.sqrt(s*s+d*d+c*c))?(p=1/p,s*=p,d*=p,c*=p):c=d=s=0,r[0]=h,r[1]=s,r[2]=i,r[3]=0,r[4]=l,r[5]=d,r[6]=u,r[7]=0,r[8]=a,r[9]=c,r[10]=e,r[11]=0,r[12]=-(h*n+l*o+a*t),r[13]=-(s*n+d*o+c*t),r[14]=-(i*n+u*o+e*t),r[15]=1,r},ye.str=function(t){
return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+"]"},quat4={},quat4.create=function(t){var e=new glMatrixArrayType(4);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e},quat4.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},we.linearMix=function(t,e,i,r){r||(r=we.create());var n=1-i;return r[0]=t[0]*i+e[0]*n,r[1]=t[1]*i+e[1]*n,r[2]=t[2]*i+e[2]*n,r},we.x=function(t,e){var i=we.create(t);return we.scale(i,e)},we.ncross=function(t,e){var i=we.create(t);return we.cross(i,e);
},we.nsubtract=function(t,e){var i=we.create(t);return we.subtract(i,e)},we.nadd=function(t,e){var i=we.create(t);return we.add(i,e)},we.nadd3=function(t,e){var i=we.create(t);return we.add(i,e)},we.nnegate=function(t){var e=we.create(t);return we.negate(e)},we.distance=function(t,e){var i=t[0]-e[0],r=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(i*i+r*r+n*n)},ye.nidentity=function(){return ye.identity(ye.create())},s.prototype.pushMatrix=function(t){this.stackTop>=this.stack.length&&this.stack.push(ye.create()),t?(ye.set(t,this.stack[this.stackTop]),ye.set(t,this.current)):ye.set(this.current,this.stack[this.stackTop]),
++this.stackTop},s.prototype.popMatrix=function(){if(0===this.stackTop)throw"Invalid popMatrix!";return--this.stackTop,ye.set(this.stack[this.stackTop],this.current),this.current},s.prototype.loadIdentity=function(){ye.identity(this.current)},s.prototype.load=function(t){ye.set(t,this.current)},s.prototype.multMatrix=function(t){ye.multiply(this.current,t)},s.prototype.translate=function(t){ye.translate(this.current,t)},s.prototype.scale=function(t){ye.scale(this.current,[t,t,t])},s.prototype.rotate=function(t,e){ye.rotate(this.current,o(t),e)},s.prototype.rotateX=function(t){ye.rotateX(this.current,o(t));
},s.prototype.rotateY=function(t){ye.rotateY(this.current,o(t))},s.prototype.rotateZ=function(t){ye.rotateZ(this.current,o(t))},s.prototype.perspective=function(t,e,i,r){ye.perspective(t,e,i,r,this.current)};var be=new s,_e=new s;u.prototype.init=function(t,e){var i=l($e,t),r=l($e,e);return this.prog=$e.createProgram(),$e.attachShader(this.prog,r),$e.attachShader(this.prog,i),$e.linkProgram(this.prog),$e.getProgramParameter(this.prog,$e.LINK_STATUS)?void 0:(alert("Could not initialise shaders"),null)},u.prototype.enableArrs=function(t){t?($e.enableVertexAttribArray(this.vertexPositionAttribute),
void 0!==this.vertexNormalAttribute&&$e.enableVertexAttribArray(this.vertexNormalAttribute)):($e.disableVertexAttribArray(this.vertexPositionAttribute),void 0!==this.vertexNormalAttribute&&$e.disableVertexAttribArray(this.vertexNormalAttribute))},u.prototype.initBkgParams=function(){$e.useProgram(this.prog),this.vertexPositionAttribute=$e.getAttribLocation(this.prog,"aVertexPosition"),this.pMatrixUniform=$e.getUniformLocation(this.prog,"uPMatrix"),this.mvMatrixUniform=$e.getUniformLocation(this.prog,"uMVMatrix"),this.timeUniform=$e.getUniformLocation(this.prog,"time"),this.textureUniform=$e.getUniformLocation(this.prog,"noisef");
},u.prototype.initNormParams=function(){$e.useProgram(this.prog),this.vertexPositionAttribute=$e.getAttribLocation(this.prog,"aVertexPosition"),this.vertexNormalAttribute=$e.getAttribLocation(this.prog,"aVertexNormal"),this.pMatrixUniform=$e.getUniformLocation(this.prog,"uPMatrix"),this.mvMatrixUniform=$e.getUniformLocation(this.prog,"uMVMatrix"),this.useLightingUniform=$e.getUniformLocation(this.prog,"uUseLighting"),this.ambientColorUniform=$e.getUniformLocation(this.prog,"uAmbientColor"),this.pointLightingLocationUniform=$e.getUniformLocation(this.prog,"uPointLightingLocation"),this.pointLightingSpecularColorUniform=$e.getUniformLocation(this.prog,"uPointLightingSpecularColor"),
this.pointLightingDiffuseColorUniform=$e.getUniformLocation(this.prog,"uPointLightingDiffuseColor"),this.globColorUniform=$e.getUniformLocation(this.prog,"uGlobColor"),this.twoSidedUniform=$e.getUniformLocation(this.prog,"uTwoSided")},u.current=null,u.use=function(t){u.current!==t&&(null!==u.current&&u.current.enableArrs(!1),null===t||void 0===t?($e.useProgram(null),u.current=null):($e.useProgram(t.prog),u.current=t,null!==u.current&&u.current.enableArrs(!0)))},u.prototype.setMatrixUniforms=function(){$e.uniformMatrix4fv(this.pMatrixUniform,!1,_e.current),$e.uniformMatrix4fv(this.mvMatrixUniform,!1,be.current);
},u.prototype.setColor=function(t,e,i){$e.uniform4f(this.globColorUniform,t,e,i,1)},u.prototype.setColor4=function(t,e,i,r){$e.uniform4f(this.globColorUniform,t,e,i,r)},u.prototype.setColorv=function(t){$e.uniform4f(this.globColorUniform,t[0],t[1],t[2],1)},u.prototype.setColor4v=function(t){$e.uniform4f(this.globColorUniform,t[0],t[1],t[2],t[3])},u.prototype.setTwoSided=function(t){$e.uniform1i(this.twoSidedUniform,t)},u.prototype.setUseLight=function(t){$e.uniform1i(this.useLightingUniform,t)},u.prototype.enableNormals=function(t){t?$e.enableVertexAttribArray(this.vertexNormalAttribute):$e.disableVertexAttribArray(this.vertexNormalAttribute);
},u.prototype.setTime=function(t){$e.uniform1f(this.timeUniform,t)},h.Data=function(t,e,i,r){if(4!=arguments.length)throw new Error("GLBuffer.Data needs 4 arguments");var n=new h(t);return $e.bindBuffer(n.target,n.buf),$e.bufferData(n.target,e,i),n.itemSize=r,n.numItems=e.length/r,e instanceof Float32Array?n.type=$e.FLOAT:e instanceof Uint32Array?n.type=$e.UNSIGNED_INT:e instanceof Int32Array?n.type=$e.INT:e instanceof Uint16Array?n.type=$e.UNSIGNED_SHORT:e instanceof Int16Array?n.type=$e.SHORT:e instanceof Uint8Array?n.type=$e.UNSIGNED_BYTE:e instanceof Int8Array&&(n.type=$e.BYTE),n},h.Size=function(t,e,i,r,n,o){
if(arguments.length<5)throw new Error("GLBuffer.Size needs 5 or 6 arguments");var a=new h(t);a.itemSize=i,a.numItems=0,a.allocElements=i*r;var s=c()[e];return a.bytesInElement=s.byteSize,$e.bindBuffer(a.target,a.buf),$e.bufferData(a.target,a.bytesInElement*i*r,n),o&&(a.record=new s.arrCtor(i*r)),a},h.prototype.append=function(t){if(!this.allocElements)throw new Error("Cannot append to this kind of GLBuffer");if(t.BYTES_PER_ELEMENT!==this.bytesInElement)throw new Error("Cannot append this type of array "+t.toString+" != "+this.bytesInElement);if(this.numItems+t.length>=this.allocElements)return null;
if($e.bindBuffer(this.target,this.buf),$e.bufferSubData(this.target,this.numItems*this.itemSize*this.bytesInElement,t),this.record)for(var e=0;e<t.length;++e)this.record[this.numItems*this.itemSize+e]=t[e];var i=this.numItems;return this.numItems+=t.length/this.itemSize,i},h.prototype.backtrack=function(t){this.numItems-=t,this.numItems=Math.max(this.numItems,0)},h.prototype.bind=function(){$e.bindBuffer(this.target,this.buf)},h.prototype.rewriteWithRecord=function(){$e.bindBuffer(this.target,this.buf),$e.bufferSubData(this.target,0,this.record)};var Se={Left:{name:"Left",opposite:{},leftHand:{},
rightHand:{},move:null},Right:{name:"Right",opposite:{},leftHand:{},rightHand:{},move:null},Up:{name:"Up",opposite:{},leftHand:{},rightHand:{},move:null},Down:{name:"Down",opposite:{},leftHand:{},rightHand:{},move:null}};Se.Left.opposite=Se.Right,Se.Left.leftHand=Se.Down,Se.Left.rightHand=Se.Up,Se.Right.opposite=Se.Left,Se.Right.leftHand=Se.Up,Se.Right.rightHand=Se.Down,Se.Up.opposite=Se.Down,Se.Up.leftHand=Se.Left,Se.Up.rightHand=Se.Right,Se.Down.opposite=Se.Up,Se.Down.leftHand=Se.Right,Se.Down.rightHand=Se.Left,Se.getRelativeDir=function(t,e){return e===Se.Left?t.leftHand:e===Se.Right?t.rightHand:e===Se.Up?t:e===Se.Down?t.opposite:null;
};var Me=[{model:[.2,.22,1],trail:[.1,.1,1],text:"#3939FF",name:"Blue"},{model:[1,.12,.1],trail:[1,.1,.1],text:"#FF1313",name:"Red"},{model:[1,.43,0],trail:[1,.48,0],text:"#FF6701",name:"Orange"},{model:[0,.82,.1],trail:[0,.9,.1],text:"#14A800",name:"Green"},{model:[.74,.1,1],trail:[.71,0,1],text:"#D21DFF",name:"Purple"},{model:[1,.92,.1],trail:[1,.92,.1],text:"#FFE401",name:"Yellow"}];g.prototype.init=function(){this.normal=ni.model.normals[this.point],this.rightHand=we.ncross(this.forward,this.normal);var t=2*ni.model.vtx.length;this.wall.idxRbuf=h.Size($e.ELEMENT_ARRAY_BUFFER,$e.UNSIGNED_SHORT,1,t,$e.DYNAMIC_DRAW),
this.wall.idxLbuf=h.Size($e.ELEMENT_ARRAY_BUFFER,$e.UNSIGNED_SHORT,1,t,$e.DYNAMIC_DRAW),this.wall.idxTbuf=h.Size($e.ELEMENT_ARRAY_BUFFER,$e.UNSIGNED_SHORT,1,t,$e.DYNAMIC_DRAW);var e=3*ni.model.vtx.length*4;this.wall.vtxBuf=h.Size($e.ARRAY_BUFFER,$e.FLOAT,3,e,$e.DYNAMIC_DRAW,!0),this.wall.normalsBuf=h.Size($e.ARRAY_BUFFER,$e.FLOAT,3,e,$e.DYNAMIC_DRAW),this.wall.idxTbuf.append(new Uint16Array([0,2,4,5])),this.postMove(this.eDir),this.ready=!0},f.POINT_DELAY=4,f.prototype.addRawPoint=function(){function t(){for(var t=0,e=1;7>e;++e)d[t++]=arguments[e][0],d[t++]=arguments[e][1],d[t++]=arguments[e][2];
return d}function e(t,e){return c[0]=t,c[1]=e,c}var i=we.create(),r=we.create(),n=we.create(),o=we.create(),a=we.create(),s=we.create(),l=we.create(),u=we.create(),h=we.create(),d=new Float32Array(18),c=new Uint16Array(2);return function(c,p,f,g,m,v){var w=ni.model.scale.WALL_WIDTH,x=ni.model.scale.WALL_HEIGHT;we.set(v,i),we.scale(i,p),we.set(v,r),we.scale(r,c),we.set(m,n),we.add(n,i),we.set(m,o),we.negate(o),we.add(o,r),si.bikeFlip&&(we.negate(g,a),g=a),this.normalsBuf.append(t(d,n,n,o,o,g,g)),we.set(m,s),we.scale(s,w),we.add(s,f),we.scale(i,w),we.add(s,i),we.set(m,l),we.scale(l,-w),we.add(l,f),
we.scale(r,w),we.add(l,r),we.scale(g,x,i),we.set(s,u),we.add(u,i),we.set(l,h),we.add(h,i);var y=this.vtxBuf.append(t(d,s,u,l,h,u,h));this.idxRbuf.append(e(y,y+1)),this.idxLbuf.append(e(y+2,y+3)),this.idxTbuf.append(e(y+4,y+5))}}(),f.prototype.addPoint=function(t,e,i){this.pntRecord.push(i.point);var r=ni.model.vtx[i.point],n=ni.model.normals[i.point];this.addRawPoint(t,e,r,n,i.rightHand,i.forward)},f.prototype.backtrackRawPoint=function(){this.vtxBuf.backtrack(6),this.normalsBuf.backtrack(6),this.idxRbuf.backtrack(2),this.idxLbuf.backtrack(2),this.idxTbuf.backtrack(2)},f.prototype.backtrackPoint=function(){
this.pntRecord.pop(),this.backtrackRawPoint()},f.prototype.queuePoint=function(t,e,i){if(0===f.POINT_DELAY)this.addPoint(t,e,i);else if(this.queue.push({la:t,ra:e,playerDummy:{point:i.point,forward:i.forward,rightHand:i.rightHand}}),this.queue.length>f.POINT_DELAY){var r=this.queue.shift();this.addPoint(r.la,r.ra,r.playerDummy)}},f.prototype.queueBacktrack=function(){0===f.POINT_DELAY||0===this.queue.length?this.backtrackPoint():this.queue.pop()},f.prototype.flushQueue=function(){for(;this.queue.length>0;){var t=this.queue.shift();this.addPoint(t.la,t.ra,t.playerDummy)}},f.prototype.deathEnd=function(t){
this.queueBacktrack(),this.queuePoint(-1,-1,t),this.flushQueue()},f.prototype.setWallHeight=function(t){var e=t*ni.model.scale.WALL_HEIGHT;si.bikeFlip&&(e=-e);for(var i=this.vtxBuf.record,r=this.pntRecord.length,n=0;r>n;++n){var o=we.x(ni.model.normals[this.pntRecord[n]],e),a=6*n*3,s=we.create([i[a],i[a+1],i[a+2]]);a=3*(6*n+2);var l=we.create([i[a],i[a+1],i[a+2]]);s=we.nadd(s,o),l=we.nadd(l,o),a=3*(6*n+1),i[a]=s[0],i[a+1]=s[1],i[a+2]=s[2],a=3*(6*n+4),i[a]=s[0],i[a+1]=s[1],i[a+2]=s[2],a=3*(6*n+3),i[a]=l[0],i[a+1]=l[1],i[a+2]=l[2],a=3*(6*n+5),i[a]=l[0],i[a+1]=l[1],i[a+2]=l[2]}this.vtxBuf.rewriteWithRecord();
},f.prototype.fracExtend=function(t){if(0===this.pntRecord.length)return!1;var e,i=this.pntRecord[this.pntRecord.length-1];e=this.queue.length>0?this.queue[0].playerDummy:t;var r=e.point,n=t.curStepFrac,o=we.linearMix(ni.model.vtx[r],ni.model.vtx[i],n),a=ni.model.normals[r],s=e.rightHand,l=e.forward;return this.addRawPoint(0,0,o,a,s,l),!0},g.prototype.getBikeOrient=function(){var t,e;if(0==this.wall.queue.length)t=this.forward,e=ni.model.normals[this.point];else if(1==this.wall.queue.length){var i=this.wall.queue[0].playerDummy;t=i.forward,e=ni.model.normals[i.point]}else{var r=Math.min(this.wall.queue.length-1,1),i=this.wall.queue[r].playerDummy,n=this.wall.queue[r-1].playerDummy,o=this.curStepFrac;
t=we.linearMix(i.forward,n.forward,o),e=we.linearMix(ni.model.normals[i.point],ni.model.normals[n.point],o)}return{normal:e,forward:t}};var De={rightHand:{4:1,3:1,5:1,6:1},forward:{4:2,3:1,5:2,6:3},leftHand:{4:3,3:2,5:4,6:5},back:{4:0,3:0,5:0,6:0}};g.prototype.preMove=function(t){var e;t===this.eDir.rightHand?(this.wall.queueBacktrack(),this.wall.queuePoint(1,-1,this),this.wall.flushQueue(),this.turnCallback&&this.turnCallback(!1),e=De.rightHand):t===this.eDir.leftHand?(this.wall.queueBacktrack(),this.wall.queuePoint(-1,1,this),this.wall.flushQueue(),this.turnCallback&&this.turnCallback(!0),e=De.leftHand):e=De.forward;
var i=v(this.point,e,this.last.point),r=we.nsubtract(ni.model.vtx[i],ni.model.vtx[this.point]),n=ni.model.nei[this.point].d[i];return this.last={point:this.point,normal:this.normal,upDir:this.upDir,forward:this.forward},this.point=i,this.normal=ni.model.normals[this.point],{tonext:r,dist:n}},g.prototype.postMove=function(t){this.rightHand=we.ncross(this.forward,this.normal),this.wall.queuePoint(0,0,this),this.eDir=t},g.prototype.moveUp=function(){var t=this.preMove(Se.Up);return this.rightHand=we.normalize(we.ncross(t.tonext,this.normal)),this.upDir=we.normalize(we.ncross(this.normal,this.rightHand)),
this.forward=this.upDir,this.postMove(Se.Up),t.dist},g.prototype.moveDown=function(){var t=this.preMove(Se.Down);return this.rightHand=we.normalize(we.ncross(this.normal,t.tonext)),this.upDir=we.normalize(we.ncross(this.normal,this.rightHand)),this.forward=we.nnegate(this.upDir),this.postMove(Se.Down),t.dist},g.prototype.moveLeft=function(){var t=this.preMove(Se.Left);return this.upDir=we.normalize(we.ncross(t.tonext,this.normal)),this.rightHand=we.normalize(we.ncross(this.upDir,this.normal)),this.forward=we.nnegate(this.rightHand),this.postMove(Se.Left),t.dist},g.prototype.moveRight=function(){
var t=this.preMove(Se.Right);return this.upDir=we.normalize(we.ncross(this.normal,t.tonext)),this.rightHand=we.normalize(we.ncross(this.upDir,this.normal)),this.forward=this.rightHand,this.postMove(Se.Right),t.dist},Se.Up.move=g.prototype.moveUp,Se.Down.move=g.prototype.moveDown,Se.Right.move=g.prototype.moveRight,Se.Left.move=g.prototype.moveLeft,g.prototype.prettyName=function(){return"<"+this.id+">"+this.name+"</>"};var Ae={mouseDown:!1,lastMouseX:null,lastMouseY:null,rotationMatrix:ye.nidentity(),currentlyPressedDirs:[],touchX:null,touchY:null,HANDLERS_MENU:1,HANDLERS_3D:2,handlersSet:0};if("undefined"==typeof Ee)var Ee={
DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_PAUSE:19,DOM_VK_ESCAPE:27,DOM_VK_SPACE:32,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_F1:112,DOM_VK_F2:113,
DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123};Ee._DOM_VK_OPEN_SQUARE=219,Ee._DOM_VK_CLOSE_SQUARE=221;var Te={};Te[Ee.DOM_VK_LEFT]=Se.Left,Te[Ee.DOM_VK_RIGHT]=Se.Right,Te[Ee.DOM_VK_UP]=Se.Up,Te[Ee.DOM_VK_DOWN]=Se.Down,Te[Ee.DOM_VK_W]=Se.Up,Te[Ee.DOM_VK_A]=Se.Left,Te[Ee.DOM_VK_S]=Se.Down,Te[Ee.DOM_VK_D]=Se.Right;var Re=null,Pe=null;we.minwith=function(t,e){e[0]<t[0]&&(t[0]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[2]<t[2]&&(t[2]=e[2])},we.maxwith=function(t,e){e[0]>t[0]&&(t[0]=e[0]),e[1]>t[1]&&(t[1]=e[1]),e[2]>t[2]&&(t[2]=e[2]);
},we.distance=function(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1])+(t[2]-e[2])*(t[2]-e[2]))};var Ie=100,ke=.03,Le=40,Ce=.015,Oe=[{},{stepsAhead:2},{stepsAhead:5},{stepsAhead:10},{stepsAhead:15},{stepsAhead:20}];N.prototype.turnLeft=function(){this.player.selDir=this.player.eDir.leftHand},N.prototype.turnRight=function(){this.player.selDir=this.player.eDir.rightHand},N.prototype.turnToAvailableSide=function(t,e){if(this.occRight=U(t.toRight),this.occLeft=U(t.toLeft),!this.occRight||!this.occLeft)if(this.occRight||this.occLeft)this.occRight?this.turnLeft():this.occLeft&&this.turnRight();else{
if(e&&this.checkWallHeading(t))return;if(this.checkFarBlocks())return;r(.5)?this.turnLeft():this.turnRight()}},H.prototype.init=function(t,e){return this.last=e,this.point=t,this.count=0,this.ok=!0,this},H.prototype.goRelDir=function(t){var e=this.point;return this.point=v(this.point,t,this.last),this.last=e,U(this.point)?(this.ok=!1,!1):(++this.count,!0)},H.prototype.goForward=function(){return this.goRelDir(De.forward)},H.prototype.goRight=function(){return this.goRelDir(De.rightHand)},H.prototype.goLeft=function(){return this.goRelDir(De.leftHand)},N.prototype.checkWallHeading=function(t){var e=this.player.id,i=ni.map.get(t.toFwd),r=he.piece(i);
if(!W(r,e))return!1;var n=he.meta(i),o=this.player.point,a=this.player.last.point;this.look.init(o,a).goLeft(),this.look.goRight();var s=this.look.point;this.look.init(o,a).goRight(),this.look.goLeft();var l=this.look.point,u=ni.map.get(s),h=ni.map.get(l),d=he.piece(u),c=he.piece(h),p=he.meta(u),f=he.meta(h);return Qe("wall-h "+d+":"+p+" - "+c+":"+f),W(d,e)&&W(c,e)?(n>p?this.turnLeft():this.turnRight(),!0):!1},N.prototype.checkFarBlocks=function(){var t=this.player.point,e=this.player.last.point;this.look.init(t,e).goLeft();var i=V(this.look,this.stepsAhead,1);this.look.init(t,e).goRight();var r=V(this.look,this.stepsAhead,1);
if(i>r)this.turnLeft();else{if(!(r>i))return!1;this.turnRight()}return!0},N.prototype.moveControl=function(t){var e=w(this.player.point,this.player.last.point),i=U(e.toFwd);return i?void this.turnToAvailableSide(e,!0):r(2)?void this.turnToAvailableSide(e,!1):void 0},K.TOTAL_TIME=800,K.RING_MAX_SIZE=1.5,K.SPIKES_TIME=320,K.SPIKES_MAX_SIZE=.8,K.prototype.draw=function(){be.pushMatrix(),ii.setUseLight(!1),$e.enable($e.BLEND),be.translate([0,0,1.2*-ni.model.scale.WALL_WIDTH]),be.scale(ni.model.scale.GLOBAL_SCALE);for(var t=0;t<this.ringsScale.length;++t){var e=this.ringsScale[t];if(!(.1>e||e>K.RING_MAX_SIZE)){
var i=(e-K.RING_MAX_SIZE)/(.2-K.RING_MAX_SIZE);ii.setColor4(1,.6,.1,i),be.pushMatrix(),be.scale(e,e,e),this.player===oi&&be.rotate(90,[1,0,0]),te(qe.explode.ring),be.popMatrix()}}this.showSpikes&&(be.scale(this.spikesScale,this.spikesScale,this.spikesScale),ii.setColor(1,.6+this.spikesScale,this.spikesScale),this.player===oi&&be.rotate(90,[1,0,0]),te(qe.explode.spikes)),$e.disable($e.BLEND),ii.setUseLight(!0),be.popMatrix()},K.prototype.advance=function(t){for(var e=0;e<this.ringsScale.length;++e)this.ringsScale[e]+=t*((K.RING_MAX_SIZE+1)/K.TOTAL_TIME);this.spikesScale+=t*(K.SPIKES_MAX_SIZE/K.SPIKES_TIME),
this.elapsed+=t,this.elapsed>K.SPIKES_TIME&&(this.showSpikes=!1),this.elapsed>K.TOTAL_TIME&&(this.player.sfx.explode=null,null!==Ye.handler&&Ye.called===!1&&Ye.handler())},Y.START_DELAY=500,Y.HEIGHT_DELAY=250,Y.DECENT_TIME=900,Y.BRIGHT_TIME=340,Y.DARKEN_TIME=200,Y.prototype.advance=function(t){if(this.elapsed+=t,this.elapsed<=Y.BRIGHT_TIME?this.brightness=this.elapsed*(1/Y.BRIGHT_TIME):this.brightness=Math.max(0,1-(this.elapsed-Y.BRIGHT_TIME)*(1/Y.DARKEN_TIME)),this.elapsed>=Y.HEIGHT_DELAY&&(this.height=1-(this.elapsed-Y.BRIGHT_TIME)*(1/Y.DECENT_TIME),this.height=Math.min(1,Math.max(0,this.height))),
this.height<=0){this.player.sfx.wall_decent=null;var e=this.player.wall;e.standing=!1;for(var i=0;i<e.pntRecord.length-1;++i)ni.map.unset(e.pntRecord[i])}else this.player.wall.setWallHeight(this.height)},Q.prototype.startRemove=function(){this.removeElapsed=0,this.alpha=1},Q.prototype.getColor=function(t){return a(t/360,1,.5)},Q.prototype.draw=function(){be.pushMatrix(),be.translate(ni.model.vtx[this.point]);var t=ee(this.rightHand,this.normal,this.forward);be.multMatrix(t);var e=ni.model.scale.BONUS_LIFE;si.bikeFlip&&(e=-e),be.translate([0,2.3*e,0]),be.scale(e*this.inflate),be.rotateY(this.anglex),
be.rotateX(this.angley),color=this.getColor(this.anglex),null==this.alpha?ii.setColorv(color):($e.enable($e.BLEND),ii.setColor4(color[0],color[1],color[2],this.alpha)),te(qe.life),null!=this.alpha&&$e.disable($e.BLEND),be.popMatrix()},Q.INFLATE_TIME=500,Q.REMOVE_TIME=500,Q.prototype.advance=function(t){if(At.prototype.rotate.call(this,t),this.elapsed<Q.INFLATE_TIME)this.elapsed=Math.min(this.elapsed+t,Q.INFLATE_TIME),this.inflate=this.elapsed*(1/Q.INFLATE_TIME);else if(-1!=this.removeElapsed){this.removeElapsed=Math.min(this.removeElapsed+t,Q.REMOVE_TIME);var e=this.removeElapsed*(1/Q.REMOVE_TIME);
if(this.inflate=1+3*e,this.alpha=1-e,e>=1)return!1}else this.inflate=1;return!0},Q.prototype.action=function(t){t===oi&&(++Ge.userLivesCount,ni.staticDraw.lives.startOneUp());for(var e in this.occupy)ni.map.unset(this.occupy[e]);ni.bonuses[this.index].startRemove(),Vt(t),di.addMessage(t.prettyName()+" found a life bonus")},j.prototype.getCamera=function(){return this},j.prototype.moveUpdate=function(t){if(t===oi){var e=t.curStepFrac;we.linearMix(t.normal,t.last.normal,e,this.eye),we.scale(this.eye,this.eyeDist),we.linearMix(t.upDir,t.last.upDir,e,this.upDir)}},j.prototype.translateDir=function(t,e){
return t},j.prototype.translateRelativeDir=j.prototype.translateDir,j.prototype.getLight=function(){return this.lightPoint},Z.prototype.getCamera=function(){return this},Z.prototype.moveUpdate=function(t){if(t===oi){var e=t.curStepFrac;we.linearMix(t.normal,t.last.normal,e,this.toPoint),we.negate(this.toPoint,this.eye),we.scale(this.eye,this.centerDist),we.linearMix(t.upDir,t.last.upDir,e,this.upDir)}},Z.prototype.translateDir=function(t,e){return t===Se.Left||t===Se.Right?t.opposite:t},Z.prototype.translateRelativeDir=Z.prototype.translateDir,Z.prototype.getLight=function(){return this.lightPoint;
},J.prototype.getCamera=function(){return this},J.prototype.moveUpdate=function(t){if(t===oi){var e=t.curStepFrac;we.linearMix(ni.model.vtx[t.point],ni.model.vtx[t.last.point],e,this.eye),we.linearMix(t.forward,t.last.forward,e,this.t),we.scale(this.t,slideval1),we.add(this.t,this.eye,this.toPoint),we.linearMix(t.normal,t.last.normal,e,this.upDir),we.scale(this.upDir,.1,this.t),we.add(this.eye,this.t)}},J.prototype.translateDir=function(t,e){return Se.getRelativeDir(e.eDir,t)},J.prototype.translateRelativeDir=function(t,e){return t},J.prototype.getLight=function(){return this.lightPoint};var Fe=Math.round;
tt.prototype.inside=function(t){return t.x>=this.x&&t.y>=this.y&&t.x<=this.x+this.width&&t.y<=this.y+this.height},tt.prototype.expand=function(t){return this.x-=t,this.y-=t,this.height+=2*t,this.width+=2*t,this},tt.prototype.expanded=function(t){return new tt(this.x-t,this.y-t,this.width+2*t,this.height+2*t)},tt.prototype.down=function(t){return this.y+=t,this},tt.prototype.xmid=function(){return this.x+Fe(this.width/2)},tt.prototype.widen=function(t){return this.x-=Fe(t),this.width+=Fe(2*t),this},dt.prototype.setup2dInputs=function(){document.onkeydown=at,document.onkeyup=st,li.onmousedown=rt,
ei.onmousedown=rt,document.onmouseup=nt,document.onmousemove=it,document.onmousewheel=ot,Ae.handlersSet=Ae.HANDLERS_MENU,document.body.addEventListener("touchstart",lt,!1),document.body.addEventListener("touchmove",ut,!1),document.body.addEventListener("touchend",ht,!1),document.body.addEventListener("touchcancel",ht,!1)},dt.prototype.getCanvasCoord=function(t){return{x:t.layerX,y:t.layerY}},dt.prototype.getWidget=function(t){var e=this.getCanvasCoord(t);return this.wnd.coordWidget(e)},dt.prototype.roundedBoxPathb=function(t,e){this.roundedBoxPath(t.x,t.y,t.width,t.height,e)},dt.prototype.roundedBoxPath=function(t,e,i,r,n){
if(void 0===n)throw"r should be defined";ui.beginPath(),ui.moveTo(t+n,e),ui.arcTo(t+i,e,t+i,e+n,n),ui.arcTo(t+i,e+r,t+i-n,e+r,n),ui.arcTo(t,e+r,t,e+r-n,n),ui.arcTo(t,e,t+n,e,n)},dt.prototype.backgroundRect=function(t){ui.clearRect(t.x,t.y,t.width,t.height),void 0!==this.widgetsBackground&&(ui.fillStyle=this.widgetsBackground,ui.fillRect(t.x,t.y,t.width,t.height))},dt.prototype.drawSelect=function(t,e){if(e){var i=Math.max(t.width,t.height),r=ui.createLinearGradient(t.x,t.y,t.x+i/2,t.y+i/2);r.addColorStop(0,"rgba(136,255,19,1.0)"),r.addColorStop(1,"rgba(255,255,0,1.0)"),ui.fillStyle=r,di.roundedBoxPath(t.x,t.y,t.width,t.height,10),
ui.fillStyle="black",ui.fill(),ui.fillStyle=r,ui.fill()}else this.backgroundRect(t)},ct.EVENT_PRESS=100,ct.EVENT_MOVE=101,ct.EVENT_RELEASE=102,pt.prototype.draw=function(t){di.drawSelect(this.box,t),this.group&&this.group.testndraw(),ui.fillStyle=ft(this.box);var e="center"==ui.textAlign?this.box.x+Fe(.5*this.box.width):this.tx;ui.fillText(this.text,e,this.ty),ui.lineWidth=2,ui.strokeStyle=gt(this.box),ui.strokeText(this.text,e,this.ty)},mt.prototype.draw=function(t){di.drawSelect(this.box,t);var e=this.isOn?this.imgOn:this.imgOff;ui.drawImage(e,this.boxImg.x,this.boxImg.y,this.boxImg.width,this.boxImg.height);
},vt.prototype.draw=function(t){di.drawSelect(this.box,t),this.group&&this.group.testndraw(),null!==this.img&&ui.drawImage(this.img,this.boxImg.x,this.boxImg.y,this.boxImg.width,this.boxImg.height)},wt.prototype.draw=function(t){di.backgroundRect(this.clearBox);var e=Fe(.22*this.box.height);di.roundedBoxPath(this.box.x,this.box.y+Fe(.5*(this.box.height-e)),this.box.width,e,Fe(.5*e)),ui.fillStyle=ft(this.box),ui.fill(),ui.strokeStyle=gt(this.box),ui.lineWidth=2,ui.stroke();var i=this.box.x+this.box.width/(this.vmax-this.vmin)*(this.value-this.vmin),r=Fe(.35*di.en);di.roundedBoxPath(i-r,this.box.y,2*r,this.box.height,Fe(.7*r)),
ui.fill(),ui.stroke()},wt.prototype.onevent=function(t){var e=this.vmin+t.x/this.box.width*(this.vmax-this.vmin);e=Math.min(this.vmax,Math.max(this.vmin,e)),e=Fe(e/this.step)*this.step,e!==this.value&&(this.value=e,this.draw(!0),this.valueChanged(e)),t.name===ct.EVENT_PRESS&&(di.curPage.mouseCaptureWidget=this)},xt.prototype.draw=function(t){di.backgroundRect(this.clearBox);var e=this.box.x,i=this.box.y,r=this.box.width,n=this.box.height;di.roundedBoxPath(e,i,r,r,4),ui.stroke(),di.roundedBoxPath(e,i+n-r,r,r,4),ui.stroke();var o=n-2*r,a=this.part/this.total,s=a*o,l=o-s;di.roundedBoxPath(e,i+r+this.h,r,s,4),
ui.stroke(),this.workd=s,this.rangeh=l},xt.prototype.updateH=function(t){t=Math.min(this.rangeh,Math.max(0,t)),t!==this.h&&(this.h=t,newvalue=Fe(this.h/this.rangeh*(this.total-this.part)),this.draw(!0),this.valueChanged(newvalue))},xt.prototype.onWheelEvent=function(t){this.updateH(this.h-t.wheelDelta/3)},xt.prototype.onevent=function(t){var e=this.h;if(null!==this.pressY&&(e=this.pressH+(t.y-this.pressY)),t.name===ct.EVENT_PRESS){var i=this.box.width+this.h;t.y>=i&&t.y<=i+this.workd?(di.curPage.mouseCaptureWidget=this,this.pressY=t.y,this.pressH=this.h):t.y<this.box.width?e-=10:t.y>this.box.height-this.box.width?e+=10:t.y<i?e-=100:e+=100;
}else t.name===ct.EVENT_RELEASE&&(this.pressY=null,this.pressH=null);this.updateH(e)},dt.prototype.blankScr=function(t){t?(ui.fillStyle=t,ui.fillRect(0,0,ui.canvas.width,ui.canvas.height)):ui.clearRect(0,0,ui.canvas.width,ui.canvas.height)},bt.prototype.setBox=function(t){this.box=t},bt.prototype.testndraw=function(){this.com.sel===this.id&&(di.roundedBoxPath(this.box.x,this.box.y,this.box.width,this.box.height,10),ui.lineWidth=2,ui.fillStyle="rgba(0,0,255,0.2)",ui.fill(),ui.strokeStyle="#0000FF",ui.stroke())},dt.prototype.clearScr=function(){this.curPage={},this.curPage.widgets=[],this.curPage.sel=0,
this.curPage.background=void 0,this.curPage.keyHandler=null,this.curPage.mouseHandler=null,this.curPage.selTextBox=null,this.curPage.mouseCaptureWidget=null,this.curPage.wheelHandlers=[],this.blankScr(),this.curMenuDraw=null,this.curMenuRemake=null,this.wnd=new _t(this.curPage.widgets,null)},dt.prototype.setSelectionTextBox=function(t){var e=t.height;this.curPage.selTextBox=t.expanded(Fe(t.height/4)),this.curPage.selTextBox.th=e},_t.prototype.push=function(t,e){return void 0===e&&this.allwidgets.push(t),this.d.push(t),++this.length,t},_t.prototype.coordWidget=function(t){var e={x:t.x,y:t.y};this.box&&(e.x-=this.box.x,
e.y-=this.box.y-this.translateY);for(var i=0;i<this.length;++i){var r=this.d[i];if(void 0!==r.coordWidget){var n=r.coordWidget(e);if(n)return n}else if(r.box.inside(e))return r}return null},_t.prototype.makeTextButton=function(t,e,i,r,n,o,a){ui.measureText(t);return this.push(new pt(t,new tt(e,i,n,r),new ct(o,this.allwidgets.length),a))},_t.prototype.makeImgToggleButton=function(t,e,i,r,n,o,a,s,l){return this.push(new mt(t,e,i,r,new tt(n,o,s,a),new ct(l,this.allwidgets.length)))},_t.prototype.makeImgButton=function(t,e,i,r,n,o,a,s){return this.push(new vt(t,e,new tt(i,r,o,n),new ct(a,this.allwidgets.length),s));
},_t.prototype.makeSlider=function(t,e,i,r,n,o,a,s,l){return this.push(new wt(t,e,i,r,new tt(n,o,a,s),new ct(l,this.allwidgets.length)))},_t.prototype.makeScroll=function(t,e,i,r,n,o,a,s){return this.push(new xt(t,e,i,new tt(r,n,o,a),new ct(s,this.allwidgets.length)))},_t.prototype.makeContainer=function(t,e,i,r){return this.push(new _t(this.allwidgets,new tt(t,e,i,r)),!0)},_t.prototype.draw=function(t){if(0!==this.length){this.box&&(di.backgroundRect(this.box),di.roundedBoxPathb(this.box.expanded(7),14),ui.strokeStyle=gt(this.box),ui.lineWidth=1,ui.stroke(),ui.save(),di.roundedBoxPathb(this.box,14),
ui.clip(),ui.translate(this.box.x,this.box.y-this.translateY));for(var e=0;e<this.length;++e){var i=this.d[e];i.base?i.draw(i.base.index===t):i.draw(t)}this.box&&ui.restore()}},dt.prototype.drawWidgets=function(){if(this.wnd.draw(this.curPage.sel),0!=this.curPage.widgets.length){var t=this.curPage.widgets[this.curPage.sel].text;this.curPage.selTextBox&&t&&(this.backgroundRect(this.curPage.selTextBox),ui.fillStyle="#ff3c00",ui.textAlign="center",this.setMenuFont(this.curPage.selTextBox.th),ui.fillText(t,this.curPage.selTextBox.xmid(),this.curPage.selTextBox.y+this.curPage.selTextBox.th),ui.textAlign="start");
}};var Be="rgba(0, 0, 0, 0.8)",Ne="rgba(128, 128, 128, 0.7)";dt.prototype.preMenu=function(t){this.setup2dInputs(),this.clearScr(),this.widgetsBackground=t;var e=arguments.callee.caller,i=e.arguments;this.curMenuRemake=function(){e.apply(this,i)}},dt.prototype.setMenuFont=function(t){t||(t=this.texth),ui.font="bold "+Fe(t)+"px sans-serif"},dt.prototype.resizeAdjust=function(t,e){this.texth=Fe(42*(t/900)),this.setMenuFont(),this.em=ui.measureText("m").width,this.en=ui.measureText("n").width,Qe("text height: "+this.texth+" em: "+this.em+" "+this.en),this.drawGameState(!0),this.curMenuRemake&&this.curMenuRemake();
},dt.prototype.showStartScreen=function(){Xt(0,Ke.preloadFirst,null),de(!1),this.preMenu("black");var t=ui.canvas.width,e=ui.canvas.height,i=(Fe(t/2),Fe(e/2),this.texth),r=this.em;this.setMenuFont();var n=8*r,o=this.wnd.makeTextButton("New game",20,e-6*i,i,n,function(){Qe("NewNew!"),di.clearScr(),di.mainMenu=dt.prototype.showStartScreen,Kt(function(){Pt()})});this.wnd.makeTextButton("How to play",20,e-4.3*i,i,n,function(){di.instructionsScreen()}),this.wnd.makeTextButton("Custom level",20,e-2.6*i,i,n,function(){di.customLevelScreen()}),this.wnd.makeImgToggleButton($("#soundOnImg")[0],$("#soundOffImg")[0],"Sound",Ge.soundEnabled,t-50-2*r,e-50-2*r,2.5*r,2.5*r,function(t){
Qe("SetSnd "+t),Ge.enableSound(t)}),this.blankScr("black");var a=$("#titleTextImg")[0];ui.drawImage(a,0,0,t,Fe(a.height/a.width*t)),this.drawVersionNum(),Ke.debug&&(this.curPage.keyHandler=function(t){if(t>=Ee.DOM_VK_F1&&t<=Ee.DOM_VK_F12){var e=t-Ee.DOM_VK_F1;return Xt(e,Ke.preloadFirst,null),Qe("NewNew! "+e),di.clearScr(),di.mainMenu=dt.prototype.showStartScreen,Kt(function(){Pt(e)}),!1}return!0}),this.curPage.keyHandler=function(t){return t===Ee.DOM_VK_D?(Ge.isDemo=!0,Ke.userIndex=-1,o.base.callback(),!1):!0},this.drawWidgets(),Ge.isDemo&&this.curPage.keyHandler(Ee.DOM_VK_D)},dt.prototype.drawVersionNum=function(){
ui.textAlign="right",ui.fillStyle="#333",ui.font="10px sans-serif",ui.fillText(Ke.version,ui.canvas.width,10),this.setMenuFont(),ui.textAlign="start"},dt.prototype.drawHoverBox=function(t,e,i,r){ui.fillStyle=Be,ui.strokeStyle=Ne,ui.lineWidth=5,this.roundedBoxPath(Fe(t),Fe(e),Fe(i),Fe(r),20),ui.fill(),ui.stroke()},dt.prototype.levelComplete=function(t,e){this.preMenu(Be);var i=Fe(ui.canvas.width/2),r=Fe(ui.canvas.height/2),n=this.en,o=this.texth;Fe(o/2);this.wnd.makeImgButton($("#againImg")[0],"This one again",i-7*n,r,4*n,4*n,function(){di.clearScr(),Et(e)}),this.wnd.makeImgButton($("#menuImg")[0],"Exit game",i-2*n,r,4*n,4*n,function(){
di.showStartScreen()});var a=this.wnd.makeImgButton($("#nextImg")[0],"Next level",i+3*n,r,4*n,4*n,function(){return di.clearScr(),e===We.length-1?void this.showStartScreen():void(-1!==t?Xt(t+1,Ke.preloadBatch,function(){Et(t+1)}):di.customLevelScreen())});this.curPage.sel=2,this.setSelectionTextBox(new tt(i-6*n,r+5*n,12*n,.7*o)),this.curMenuDraw=function(){this.setMenuFont(),this.drawHoverBox(i-9*this.en,r-2.5*this.texth,18*this.en,7*o),ui.fillStyle="#ff3c00",ui.textAlign="center",ui.fillText((-1!==t?"Level "+(t+1):"Level")+" Completed!",i,r-this.texth),ui.textAlign="start",this.drawWidgets()},
this.drawGameState(),Ge.isDemo&&a.base.callback()},dt.prototype.lifeEndScreen=function(t,e){this.preMenu(Be);var i=Fe(ui.canvas.width/2),r=Fe(ui.canvas.height/2),n=this.texth,o=this.en,a=this.wnd.makeImgButton($("#againImg")[0],"Try again",i-5*o,r,4*o,4*o,function(){di.clearScr(),-1!==e&&(t=e),Et(t)});this.wnd.makeImgButton($("#menuImg")[0],"Exit Game",i+1*o,r,4*o,4*o,function(){di.mainMenu()}),this.setSelectionTextBox(new tt(i-6*o,r+5*o,12*o,.7*n)),this.curMenuDraw=function(){this.setMenuFont(),this.drawHoverBox(i-7*o,r-2.5*n,14*o,6.5*n),ui.fillStyle="#ff3c00",ui.textAlign="center",ui.fillText("You crashed!",i,r-40),
ui.textAlign="start",this.drawWidgets()},this.drawGameState(),Ge.isDemo&&a.base.callback()},dt.prototype.gameOverScreen=function(t,e){this.preMenu(Be);var i=Fe(ui.canvas.width/2),r=Fe(ui.canvas.height/2),n=this.texth,o=this.en,a=this.wnd.makeImgButton($("#menuImg")[0],"Back to menu",i-2*o,r,4*o,4*o,function(){di.mainMenu()});this.setSelectionTextBox(new tt(i-6*o,r+5*o,12*o,.7*n)),this.curMenuDraw=function(){this.setMenuFont(),this.drawHoverBox(i-7*this.en,r-2.5*n,14*o,6.5*n),ui.fillStyle="#ff3c00",ui.textAlign="center",ui.fillText("Game Over!",i,r-this.texth),ui.textAlign="start",this.drawWidgets();
},this.drawGameState(),Ge.isDemo&&a.base.callback()},dt.prototype.verbosePauseScreen=function(){function t(){di.clearScr(),di.drawGameState(),Rt(),Ge.setPaused(!1)}this.preMenu(Be);var e=Fe(ui.canvas.width/2),i=Fe(ui.canvas.height/2),r=this.en,n=(this.em,this.texth);this.wnd.makeImgButton($("#resumeImg")[0],"Resume",e-7*r,i,4*r,4*r,function(){t()}),this.wnd.makeImgButton($("#menuImg")[0],"End game",e-2*r,i,4*r,4*r,function(){Ge.isDemo=!1,di.mainMenu()}),this.wnd.makeImgToggleButton($("#soundOnImg")[0],$("#soundOffImg")[0],"Sound",Ge.soundEnabled,e+3*r,i,4*r,4*r,function(t){Qe("SetSnd "+t),Ge.enableSound(t);
}),this.setSelectionTextBox(new tt(e-6*r,i+5*r,12*r,.7*n)),this.curMenuDraw=function(){this.setMenuFont(),this.drawHoverBox(e-8*r,i-2.2*n,16*r,6.5*n),ui.fillStyle="#ff3c00",ui.textAlign="center",ui.fillText("Paused",e,i-n),ui.textAlign="start",this.drawWidgets(Be)},this.curPage.keyHandler=function(e){return e===Ee.DOM_VK_ESCAPE?(t(),!1):!0},this.fadeIn()},dt.prototype.fadeIn=function(){li.style.opacity=0,this.menuAnim=function(t){op=parseFloat(li.style.opacity)+.008*t,op>=1&&(op=1,di.menuAnim=null),li.style.opacity=op,this.drawGameState()}},dt.prototype.loadingScreen=function(t){this.blankScr("black"),
this.setup2dInputs(),de(!1);var e=Fe(ui.canvas.width/2),i=Fe(ui.canvas.height/2);this.setMenuFont(),ui.fillStyle="#ff3c00",ui.textAlign="center",ui.fillText("Loading... ",e,i),ui.textAlign="start",ui.fillStyle="rgb(100,0,0)";var r=Fe(e/2),n=this.texth;ui.fillRect(r,i+this.texth,2*r,n),ui.fillStyle="rgb(200,0,0)",ui.fillRect(r+5,i+this.texth+5,2*t*(r-10),n-10)},dt.prototype.instructionsScreen=function(){this.preMenu();var t=ui.canvas.width,e=ui.canvas.height,i=Fe(t/2),r=(Fe(e/2),this.texth),n=(this.em,this.en),o=$("#instructImg")[0];ui.drawImage(o,0,0,t,Fe(o.height/o.width*t));var a=$("#instructHeader")[0],s=Fe(678/o.width*t);
ui.drawImage(a,i-Fe(s/2),0,s,Fe(a.height/a.width*s)),this.curPage.keyHandler=this.curPage.mouseHandler=function(){return di.end3dAbove(),di.showStartScreen(),window.history.back(),window.onpopstate=null,!1},window.history.pushState("inst","Instructions",""),window.onpopstate=function(){di.end3dAbove(),di.showStartScreen(),window.onpopstate=null};var l=Fe(1.5*r);this.render3d=[new St(new tt(1.2*n,.18*e,l,l)),new Mt(new tt(i-2.5*n,.19*e,2*l,l)),new Dt(new tt(i-2.5*n,.07*e,2*l,l))],this.start3dAbove()};var Ue={worldSel:new yt(0),numPlayersSel:new yt(2),aiSel:new yt(1),speedSel:100};dt.prototype.customLevelScreen=function(){
this.preMenu("black"),de(!1);var t=ui.canvas.width,e=ui.canvas.height,i=(Fe(t/2),Fe(e/2),this.texth),r=this.em,n=this.en,o=Fe(e/4.2),a=Fe(.8*o),s=Fe(di.em/4),l=Ue,u=this.wnd.makeContainer(Fe(r-s),Fe(.08*e),Fe(4.8*o+2*s),Fe(.48*e));u.translateY=0;for(var h=0;h<We.length;++h){var d=null;null!==We[h].icon&&(d=new Image,d.src=We[h].icon,d.onload=function(){di.drawWidgets()}),u.makeImgButton(d,"",o*(h%5)+s,o*Math.floor(h/5)+s,a,a,function(t){return function(){l.worldSel.sel=t,di.drawWidgets()}}(h),new bt(l.worldSel,h))}this.blankScr("black"),ui.fillStyle="#ff3c00",di.setMenuFont(.7*i),ui.fillText("Select World:",n,Fe(.7*i));
var c=Fe(.68*e);ui.fillText("Number of Players:",n,c);var p=Fe(.81*e);ui.fillText("Difficulty:",n,p);var f=Fe(.94*e);ui.fillText("Speed:",n,f),di.setMenuFont(i),ui.textAlign="center";for(var h=1;6>=h;++h)this.wnd.makeTextButton(h,11*n+h*r*1.5,c-.9*i,i,n,function(t){return function(){l.numPlayersSel.sel=t,di.drawWidgets()}}(h),new bt(l.numPlayersSel,h));for(var g=[{txt:"easy",d:1},{txt:"medium",d:3},{txt:"hard",d:5}],m=7*n,h=0;h<g.length;++h){var v=g[h],w=n*(v.txt.length+1);this.wnd.makeTextButton(v.txt,m,p-.9*i,i,w,function(t){return function(){l.aiSel.sel=t,di.drawWidgets()}}(h),new bt(l.aiSel,h)),
m+=w+n}var x=new tt(.69*t,.88*e,4.5*n,i),y=(this.wnd.makeSlider(50,300,5,Ue.speedSel,6*n,.89*e,.5*t,1.1*i,function(t){di.backgroundRect(x),ui.fillStyle="#ff3c00",ui.textAlign="right",ui.fillText(t+"%",x.x+x.width,x.y+i-1),ui.textAlign="center",Ue.speedSel=t}),this.wnd.makeScroll(400,200,0,u.drawScroll.x,u.drawScroll.y,30,u.drawScroll.height,function(t){u.translateY=t,di.drawWidgets()}));di.curPage.wheelHandlers=[{box:u.box,handler:function(t){y.onWheelEvent(t)}}],this.wnd.makeImgButton($("#menuImg")[0],"Exit game",t-5*n,e-10*n,4*n,4*n,function(){di.showStartScreen(),window.history.back(),window.onpopstate=null;
}),this.wnd.makeImgButton($("#nextImg")[0],"Next level",t-5*n,e-5*n,4*n,4*n,function(){di.clearScr(),worldLvl=l.worldSel.sel,Xt(worldLvl,Ke.preloadBatch,function(){Ge.currentLevelNum=-1,Ge.userLivesCount=3,di.mainMenu=dt.prototype.customLevelScreen,ui.textAlign="start",Et({worldModel:We[worldLvl].worldModel,view:We[worldLvl].view,numPlayers:l.numPlayersSel.sel,ai:g[l.aiSel.sel].d,speed:Ue.speedSel/100})})}),this.curPage.keyHandler=function(t){return t===Ee.DOM_VK_ESCAPE?(di.showStartScreen(),window.history.back(),window.onpopstate=null,!1):!0},window.history.pushState("custom","Custom Level",""),
window.onpopstate=function(){di.showStartScreen(),window.onpopstate=null},di.setMenuFont(i),ui.textAlign="center",this.drawWidgets()},St.prototype.draw=function(){$e.viewport(this.box.x,this.box.y,this.box.width,this.box.height),_e.load(ye.ortho(-1,1,1,-1,.1,100)),be.pushMatrix(),be.translate([0,0,-10]),be.scale(.3),be.rotateX(this.anglex),be.rotateZ(this.angley),ii.setColorv(Q.prototype.getColor(this.anglex)),te(qe.life),be.popMatrix()},St.prototype.advance=function(t){At.prototype.rotate.call(this,t)},Mt.prototype.draw=function(){$e.viewport(this.box.x,this.box.y,this.box.width,this.box.height);
var t=this.box.height/this.box.width;_e.load(ye.ortho(-1,1,t,-t,.1,100)),be.pushMatrix(),be.translate([0,0,-10]),be.scale(.3),be.rotateX(57),be.rotateZ(106),te(qe.bike,Me[Ke.userIndex].model),be.popMatrix()},Dt.prototype.draw=function(){$e.viewport(this.box.x,this.box.y,this.box.width,this.box.height);var t=this.box.height/this.box.width;_e.load(ye.ortho(-1,1,t,-t,.1,100));for(var e=0;e<this.colors.length+1;++e)be.pushMatrix(),be.translate([0,0,-10]),be.rotateX(57),be.rotateZ(106),be.translate([0,-this.move*this.colors.length*2+2*e,0]),be.scale(.3),te(qe.bike,this.colors[e%this.colors.length]),
be.popMatrix()},Dt.prototype.advance=function(t){for(this.move+=1e-4*t;this.move>1;)this.move-=1},dt.prototype.draw3d=function(t){$e.clear($e.COLOR_BUFFER_BIT|$e.DEPTH_BUFFER_BIT),be.loadIdentity(),re(),ii.setTwoSided(!0);for(var e in this.render3d){var i=this.render3d[e];i.advance&&i.advance(t),i.draw()}},dt.prototype.start3dAbove=function(){this.has3dContent=!0,ei.style.zIndex=2,$e.clearColor(0,0,0,0),si=new j},dt.prototype.end3dAbove=function(){di.render3d=[],di.has3dContent=!1,ei.style.zIndex=0,$e.clearColor(0,0,0,1),$e.clear($e.COLOR_BUFFER_BIT|$e.DEPTH_BUFFER_BIT),si=null},dt.prototype.drawColorText=function(t,e,i,r){
var n=[],o=t.match(/<([0-9]*|\/)>/g);null===o&&(o=[]);for(var a=0,s=0;s<o.length;++s){var l=o[s];a=t.indexOf(l,a),t=t.slice(0,a)+t.slice(a+l.length),n.push({s:a,n:parseInt(l.slice(1,-1))})}for(var u=ui.measureText(t).width,h=e-u,a=0,d=ui.fillStyle,s=0;s<n.length;s+=2){var c=n[s].s,p=n[s+1].s;if(p!==c){var f=t.slice(a,c);ui.fillStyle=d,ui.fillText(f,h,i),a+=f.length,h+=ui.measureText(f).width}f=t.slice(c,p),ui.fillStyle=r(n[s].n),ui.fillText(f,h,i),a+=f.length,h+=ui.measureText(f).width}var f=t.slice(a);ui.fillStyle=d,ui.fillText(f,h,i)},dt.prototype.drawGameState=function(t){if(hi&&(this.blankScr(),
ui.font="bold "+Fe(.667*this.texth)+"px sans-serif",ui.fillStyle="#dda7ff",ui.fillText("Lives:",5,this.texth),this.msgQueue.length>0)){ui.font="bold 18px sans-serif";for(var e=ui.canvas.width,i=(ui.canvas.height,0);i<this.msgQueue.length;++i){var r=this.msgQueue[i].text;this.drawColorText(r,e-5,25+22*i,function(t){return ai[t].textColor})}}this.curMenuDraw&&!t&&this.curMenuDraw.call(this)},dt.MSGID_START_ARROWS=1001,dt.MSGID_PAUSE=1002,dt.prototype.addMessage=function(t,e){this.msgQueue.push({text:t,outTime:(new Date).getTime()+8e3,id:e}),this.drawGameState()},dt.prototype.removeMessage=function(t){
var e=!1,i=[];for(var r in this.msgQueue)this.msgQueue[r].id===t?e=!0:i.push(this.msgQueue[r]);e&&(this.msgQueue=i,this.drawGameState())},dt.prototype.checkMessageQueue=function(){if(0!==this.msgQueue.length&&!Ge.isPaused()&&Ae.handlersSet!==Ae.HANDLERS_MENU){for(var t=(new Date).getTime(),e=0;this.msgQueue.length&&this.msgQueue[0].outTime<t;)this.msgQueue.shift(),++e;hi&&e>0&&this.drawGameState()}},dt.prototype.clearMessages=function(){this.msgQueue=[]},At.prototype.render=function(){that=this;var t=function(t,e){be.pushMatrix(),be.translate([.172+.068*t,.048,-1]),be.scale(.011*e),be.rotateX(that.anglex+20*t),
be.rotateZ(that.angley+20*t),te(qe.life),be.popMatrix()};_e.pushMatrix(),_e.load(this.prMatrix),ii.setColorv(this.color);for(var e=0;e<this.count;++e)t(e,1);if(void 0!==this.activeDeath||void 0!==this.activeOneUp){ii.setColorv(we.x(this.color,this.lightFactor));var i=.2*(this.lightFactor-1)+1;t(e,i)}_e.popMatrix()},At.ROTX_SPEED=.09,At.ROTY_SPEED=.18,At.PASS_PEAK_LIGHT=3,At.PASS_PEAK_TIME=500,At.PASS_TOTAL_TIME=1e3,At.getLightFactor=function(t,e){if(t>=0){if(d=1+2*Math.sin(t/At.PASS_TOTAL_TIME*Math.PI),d>0)return d;if(t<=At.PASS_PEAK_TIME)return 1+At.PASS_PEAK_LIGHT/At.PASS_PEAK_TIME*t;if(t<=At.PASS_TOTAL_TIME)return At.PASS_PEAK_LIGHT-At.PASS_PEAK_LIGHT/(At.PASS_TOTAL_TIME-At.PASS_PEAK_TIME)*(t-At.PASS_PEAK_TIME);
}return e(),1},At.prototype.rotate=function(t){for(this.anglex+=At.ROTX_SPEED*t;this.anglex>360;)this.anglex-=360;for(this.angley+=At.ROTY_SPEED*t;this.angley>360;)this.angley-=360},At.prototype.advance=function(t){if(this.rotate(t),void 0!==this.activeOneUp){var e=this;this.activeOneUp+=t,this.lightFactor=At.getLightFactor(At.PASS_TOTAL_TIME-this.activeOneUp,function(){++e.count,e.activeOneUp=void 0,e.pendingDeath&&(e.pendingDeath=!1,e.startDeath())})}else if(void 0!==this.activeDeath){var e=this;this.activeDeath+=t,this.lightFactor=At.getLightFactor(this.activeDeath,function(){e.activeDeath=void 0;
})}},At.prototype.startDeath=function(){return void 0!==this.activeOneUp?void(this.pendingDeath=!0):(--this.count,void(this.activeDeath=0))},At.prototype.startOneUp=function(){this.activeOneUp=0};var He=219;worldModels={cube:{file:"modelsz/cube5quads.jsonz",eyeDist:3.3},triCorner:{file:"modelsz/triCorner4.jsonz",eyeDist:7},plus:{file:"modelsz/plus4q.jsonz",eyeDist:7},dblsofa:{file:"modelsz/dbl_sofa_soft_4q.jsonz",eyeDist:3.3},softsofa:{file:"modelsz/sofa4q_soft.jsonz",eyeDist:3.54},dDiamond:{file:"modelsz/distortDiamond5q.jsonz",eyeDist:4},torus:{file:"modelsz/torus_100_50s.jsonz",eyeDist:3.66},
tetra:{file:"modelsz/tetra1_4q.jsonz",eyeDist:3.4},mobius:{file:"modelsz/mobius_10r_3q.jsonz",eyeDist:1},rotDounut:{file:"modelsz/rot_dounut2.jsonz",eyeDist:4}};var Ve={Outside:0,Inside:1,FirstPerson:2},We=[{worldModel:"cube",numPlayers:2,ai:1,icon:"img/m_cube.png"},{worldModel:"dblsofa",numPlayers:4,ai:1,icon:"img/m_dbl_sofa.png"},{worldModel:"tetra",numPlayers:3,ai:2,icon:"img/m_tetra.png"},{worldModel:"triCorner",numPlayers:4,ai:2,icon:"img/m_triCorner.png"},{worldModel:"dDiamond",numPlayers:4,ai:3,icon:"img/m_diamond.png"},{worldModel:"cube",numPlayers:3,ai:3,view:Ve.Inside,icon:"img/m_inside_cube.png"
},{worldModel:"plus",numPlayers:4,ai:4,icon:"img/m_plus.png"},{worldModel:"torus",numPlayers:3,ai:4,icon:"img/m_torus.png"},{worldModel:"softsofa",numPlayers:5,ai:5,icon:"img/m_softsofa.png"},{worldModel:"mobius",numPlayers:3,ai:5,icon:"img/m_mobius.png"}],Ke={userIndex:0,disableDeath:!1,disableEndLevel:!1,debug:!1,printFps:!0,preloadFirst:1,preloadBatch:3,version:"0.3."+He},Ge=new Tt;Tt.prototype.setPaused=function(t){t?++this._paused:this._paused>0&&--this._paused,this._startPause&&0===this._paused&&(this._startPause=!1,di.removeMessage(dt.MSGID_START_ARROWS)),this._startPause||(this._paused>0?di.addMessage("paused",dt.MSGID_PAUSE):di.removeMessage(dt.MSGID_PAUSE)),
Ze=(new Date).getTime(),Qe("pause: "+this._paused)},Tt.prototype.setAbsPaused=function(t){this._paused=t?1:0,Ze=(new Date).getTime()},Tt.prototype.isPaused=function(){return this._paused>0},Tt.prototype.enableSound=function(t){this.soundEnabled=t,$.cookie("enableSound",t,{expires:14})};var Ye={handler:null,called:!1};Ft.prototype.play=function(t){var e=this.players[this.curChannel];this.curChannel=(this.curChannel+1)%this.numChannels,t!==e.volume&&(e.volume=t),e.play()};var ze=null,qe={_ready:!1},Xe={items:{},ondone:null,onprogress:null};if(jt.prototype.draw=function(){be.pushMatrix(),be.scale(this.scale),
be.rotate(4*this.time,[1,1,0]),ri.setTime(this.time),te(this.model),be.popMatrix()},jt.prototype.advance=function(t){var e=t/1e3;this.time+=e},!Qe)var Qe=function(){};var $e,je=function(){var t=0,e=0;return function(i){t+=i,++e,e>10&&($("#fpsui").text("FPS: "+Math.round(1e3/(t/e))),t=0,e=0)}}(),Ze=0,Je=0;he.prototype.getPiece=function(t){var e=this.data[t];return void 0===e?e:65535&e},he.prototype.getMeta=function(t){var e=this.data[t];return void 0===e?e:e>>16},he.prototype.get=function(t){return this.data[t]},he.piece=function(t){return 65535&t},he.meta=function(t){return t>>16},he.prototype.set=function(t,e,i){
if(e>32767||i>32767)throw Error("Out of range for map "+e+" "+i);this.data[t]=65535&e|i<<16},he.prototype.unset=function(t){delete this.data[t]};var ei,ii=new u,ri=new u,ni={map:new he,ready:!1},oi=null,ai=[],si=null,li=null,ui=null,hi=!1,di=new dt,ci=null;return{webGLStart:me,hack:ge}}();window.webGLStart=cb.webGLStart;